<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.me.irs.common.board.mapper.CommonBoardMapper">

	<!-- 게시판(공지사항, 자료실, FAQ, 법령과 지침) 총건수 조회 -->
	<select id="selectBoardListCnt" resultType="int" parameterType="map">
		/* CommonBoardMapper.selectBoardListCnt */
		SELECT COUNT(*)
		  FROM COM_BBS_BSC
		 WHERE 1=1
		   AND BBS_GROUP_MGNO = #{bbsGroupMgno}
		<if test="GbCd!= null and !GbCd.equals('') and srhNm != null and !srhNm.equals('')">
			<choose>
				<when test="GbCd != null and !GbCd.equals('nm')">
		   AND PSTAT_CN LIKE CONCAT('%', #{srhNm}, '%')
				</when>
				<otherwise>
		   AND PSTAT_NM LIKE CONCAT('%', #{srhNm}, '%')
				</otherwise>
			</choose>
		</if>
	</select>
	
	<!-- 게시판(공지사항, 자료실, FAQ, 법령과 지침) 목록 조회 -->
	<select id="selectBoardList" resultType="egovMap" parameterType="map">
		/* CommonBoardMapper.selectBoardList */
		<include refid="gov.me.irs.common.PagingMapper.pagingPreSql" />
		SELECT CAST(BBS_SN AS TEXT)
			 , BBS_GROUP_MGNO
			 , PSTAT_NM
			 , PSTAT_CN
			 , FLMNO
			 , TYPE_CD
			 , FN_GET_CODENM('TYPE_CD', TYPE_CD) AS TYPE_NM
			 , INQ_CNT
			 , TO_CHAR(REG_DT,'YYYY.mm.DD') AS REG_DT
		  FROM COM_BBS_BSC
		 WHERE 1=1
		   AND BBS_GROUP_MGNO = #{bbsGroupMgno}
		<if test="GbCd!= null and !GbCd.equals('') and srhNm != null and !srhNm.equals('')">
			<choose>
				<when test="GbCd != null and !GbCd.equals('nm')">
		   AND PSTAT_CN LIKE CONCAT('%', #{srhNm}, '%')
				</when>
				<otherwise>
		   AND PSTAT_NM LIKE CONCAT('%', #{srhNm}, '%')
				</otherwise>
			</choose>
		</if>
		 ORDER BY CAST(BBS_SN AS NUMERIC) DESC
		<include refid="gov.me.irs.common.PagingMapper.pagingPostSql" />
	</select>
	
	<!-- 공지사항, 자료실(로그인화면) 목록 조회(5건) -->
	<select id="selectBoardListLogin" resultType="egovMap" parameterType="map">
		/* CommonBoardMapper.selectBoardListLogin */
		SELECT U.TOTAL_CNT - (U.RN-1) AS NO
			 , U.*
		  FROM ( SELECT ROW_NUMBER() OVER() AS RN
					  , COUNT(*) OVER() AS TOTAL_CNT
					  , V.*
				   FROM ( SELECT CAST(BBS_SN AS TEXT)
							   , BBS_GROUP_MGNO
							   , PSTAT_NM
							   , PSTAT_CN
							   , FLMNO
							   , TYPE_CD
							   , FN_GET_CODENM('TYPE_CD', TYPE_CD) AS TYPE_NM
							   , INQ_CNT
							   , TO_CHAR(REG_DT,'YYYY.mm.DD') AS REG_DT
							FROM COM_BBS_BSC
						   WHERE 1=1
							 AND BBS_GROUP_MGNO = #{bbsGroupMgno}
						   ORDER BY CAST(BBS_SN AS NUMERIC) DESC 
						) V
			   ) U
		 LIMIT 5
		OFFSET 0
	</select>
	
	<!-- 게시판(공지사항, 자료실, 법령과 지침) 메인화면 목록 조회(5건) -->
	<select id="selectBoardListMain" resultType="egovMap" parameterType="map">
		/* CommonBoardMapper.selectBoardListMain */
		SELECT U.TOTAL_CNT - (U.RN-1) AS NO
			 , U.*
		  FROM ( SELECT ROW_NUMBER() OVER() AS RN
					  , COUNT(*) OVER() AS TOTAL_CNT
					  , V.*
				   FROM ( SELECT CAST(BBS_SN AS TEXT)
							   , BBS_GROUP_MGNO
							   , PSTAT_NM
							   , PSTAT_CN
							   , FLMNO
							   , TYPE_CD
							   , FN_GET_CODENM('TYPE_CD', TYPE_CD) AS TYPE_NM
							   , INQ_CNT
							   , TO_CHAR(REG_DT,'YYYY.mm.DD') AS REG_DT
							FROM COM_BBS_BSC
						   WHERE 1=1
							 AND BBS_GROUP_MGNO = #{bbsGroupMgno}
						   ORDER BY CAST(BBS_SN AS NUMERIC) DESC 
		 				) V
			   ) U
		 LIMIT 5
		OFFSET 0
	</select>
	
	<!-- 게시판(공지사항, 자료실, FAQ, 법령과 지침) 상세 조회 -->
	<select id="selectBoardDtl" parameterType="map" resultType="egovMap">
		/* CommonBoardMapper.selectBoardDtl */
		SELECT CAST(T1.BBS_SN AS TEXT)
			 , T1.BBS_GROUP_MGNO
			 , T1.PSTAT_NM
			 , T1.PSTAT_CN
			 , T1.FLMNO
			 , T1.TYPE_CD
			 , T1.INQ_CNT
			 , T1.REG_DT
			 , T2.PRE_BBS_SN
			 , T2.PRE_PSTAT_NM
			 , T2.POST_BBS_SN
			 , T2.POST_PSTAT_NM
		  FROM COM_BBS_BSC T1
	  	  LEFT OUTER JOIN ( SELECT LEAD(BBS_SN,1) OVER(ORDER BY CAST(BBS_SN AS NUMERIC) DESC) AS PRE_BBS_SN
	  			  				 , CASE WHEN (LEAD(BBS_SN,1) OVER() != 0 )  THEN LEAD(PSTAT_NM,1) OVER()
	  			  					    ELSE ('이전글이 없습니다.')
							       END AS PRE_PSTAT_NM
							     , LAG(BBS_SN,1) OVER() AS POST_BBS_SN
							     , CASE WHEN (LAG(BBS_SN,1) OVER() != 0 )  THEN LAG(PSTAT_NM,1) OVER()
							    	    ELSE ('다음글이 없습니다.')
								   END AS POST_PSTAT_NM
							     , BBS_SN
						 	  FROM COM_BBS_BSC 
							 WHERE BBS_GROUP_MGNO = #{bbsGroupMgno}
							 ) T2
		    ON T2.BBS_SN = T1.BBS_SN
		 WHERE T1.BBS_SN = CAST( #{bbsSn} AS NUMERIC)
	</select>
	
	<!-- 게시판(공지사항, 자료실, FAQ, 법령과 지침) 등록 -->
	<insert id="insertBoardDtl" parameterType="map">
		<selectKey keyProperty="bbsSn" resultType="String" order="BEFORE">
			/* CommonBoardMapper.insertBoardDtl.selectKey */
			SELECT NEXTVAL('BBS_SN_SEQ')
		</selectKey>
			/* CommonBoardMapper.insertBoardDtl*/
			INSERT 
			  INTO COM_BBS_BSC 
			     ( BBS_SN
				 , BBS_GROUP_MGNO
				 , PSTAT_NM
				 , PSTAT_CN
				 , FLMNO
				 , TYPE_CD
				 , INQ_CNT
				 , USE_YN
				 , DEL_YN
				 , RGTR_ID
				 , REG_DT
			     )
			VALUES 
				 ( CAST( #{bbsSn} AS NUMERIC)
				 , #{bbsGroupMgno}
				 , #{pstatNm}
				 , #{pstatCn}
				 , #{flmno}
				 , #{typeCd}
				 , 0
				 , 'Y'
				 , 'N'
				 , #{sUserId}
				 , CURRENT_TIMESTAMP
				 )
	</insert>
	
	<!-- 게시판(공지사항, 자료실, FAQ, 법령과 지침) 수정 -->
	<update id="updateBoardDtl" parameterType="map">
		/* CommonBoardMapper.updateBoardDtl*/
		UPDATE com_bbs_bsc 
		   SET PSTAT_NM = #{pstatNm}
		     , PSTAT_CN = #{pstatCn}
		     , FLMNO = #{flmno}
			 , TYPE_CD = #{typeCd}
			 <if test="useYn != null and !useYn.equals('')">
			 , USE_YN = #{useYn}
			 </if>
			 <if test="delYn != null and !delYn.equals('')">
			 , DEL_YN = #{delYn}
			 </if>
			 , MDFR_ID = #{sUserId}
			 , MDFCN_DT = CURRENT_TIMESTAMP
		 WHERE 1=1
		   AND BBS_SN = CAST( #{bbsSn} AS NUMERIC)
		   AND BBS_GROUP_MGNO = #{bbsGroupMgno}
	</update>
	
	<!-- 게시판(공지사항, 자료실, FAQ, 법령과 지침) 조회 건수 증가 -->
	<update id="updateInqCnt" parameterType="map">
		<selectKey keyProperty="inqCnt" resultType="String" order="BEFORE">
			/* CommonBoardMapper.updateInqCnt.selectKey*/
			SELECT CAST( MAX(INQ_CNT) + 1  AS TEXT) 
			  FROM com_bbs_bsc 
			 WHERE 1=1 
			   AND BBS_SN = CAST( #{bbsSn} AS NUMERIC) 
			   AND BBS_GROUP_MGNO = #{bbsGroupMgno}
		</selectKey>
		/* CommonBoardMapper.updateInqCnt*/
		UPDATE com_bbs_bsc 
		   SET INQ_CNT = CAST( #{inqCnt} AS NUMERIC)
		 WHERE 1=1
		   AND BBS_SN = CAST( #{bbsSn} AS NUMERIC)
		   AND BBS_GROUP_MGNO = #{bbsGroupMgno}
	</update>
	
	<!-- 위젯 -> 협정 조회 -->
	<select id="selectAgrCnt" resultType="egovMap">
		/* CommonBoardMapper.selectAgrCnt */
		SELECT	(SELECT COUNT(*)
		 FROM (SELECT ROW_NUMBER() OVER(partition by K.CNCLD_MGNO order by K.CNCLD_DGR DESC) as DGR_RN
			 	   , K.CNCLD_MGNO
		     	   , CAST (K.CNCLD_DGR AS TEXT)
		     	   , K.REG_TYPE_CD 
			  FROM (SELECT A.CNCLD_MGNO
				   		 , A.CNCLD_DGR
				   		 , ROW_NUMBER() OVER(partition by A.CNCLD_MGNO order by A.CNCLD_DGR DESC) as DGR_RN
				   		 , A.REG_TYPE_CD
				   		 , A.DEL_YN
			  		FROM  AGR_STIPL_BSC A) as K
		 WHERE K.DGR_RN = 1 AND K.DEL_YN ='N' and K.REG_TYPE_CD = 'RTC0003') T ) REG_TYPE_CNT01
		 , (SELECT COUNT(*)
		 FROM (SELECT ROW_NUMBER() OVER(partition by K.CNCLD_MGNO order by K.CNCLD_DGR DESC) as DGR_RN
			 	   , K.CNCLD_MGNO
		     	   , CAST (K.CNCLD_DGR AS TEXT)
		     	   , K.REG_TYPE_CD 
			  FROM (SELECT A.CNCLD_MGNO
				   		 , A.CNCLD_DGR
				   		 , ROW_NUMBER() OVER(partition by A.CNCLD_MGNO order by A.CNCLD_DGR DESC) as DGR_RN
				   		 , A.REG_TYPE_CD
				   		 , A.DEL_YN
			  		FROM AGR_STIPL_BSC A) as K
		 WHERE K.DGR_RN = 1 AND K.DEL_YN ='N' and K.REG_TYPE_CD = 'RTC0002') T ) REG_TYPE_CNT02
		 , (SELECT COUNT(*)
		 FROM (SELECT ROW_NUMBER() OVER(partition by K.CNCLD_MGNO order by K.CNCLD_DGR DESC) as DGR_RN
			 	   , K.CNCLD_MGNO
		     	   , CAST (K.CNCLD_DGR AS TEXT)
		     	   , K.REG_TYPE_CD 
			  FROM (SELECT A.CNCLD_MGNO
				   		 , A.CNCLD_DGR
				   		 , ROW_NUMBER() OVER(partition by A.CNCLD_MGNO order by A.CNCLD_DGR DESC) as DGR_RN
				   		 , A.REG_TYPE_CD
				   		 , A.DEL_YN
			  		FROM AGR_STIPL_BSC A) as K
				 WHERE K.DGR_RN = 1 AND K.DEL_YN ='N' and K.REG_TYPE_CD = 'RTC0001') T ) REG_TYPE_CNT03
	</select>
	
	<!-- 메인화면 위젯 -> 로그인 정보 조회 (방법론) -->
	<select id="selectUsrInfo" resultType="egovMap" parameterType="map">
		/* CommonBoardMapper.selectUsrInfo */
		SELECT A.USER_ID
			 , B.INST_MGNO
		  FROM USER_BSC A
		 INNER JOIN INST_BSC B
			ON A.INST_MGNO = B.INST_MGNO
		 WHERE 1=1
		   AND A.USER_ID = #{sUserId}
		   AND A.DEL_YN = 'N'
		   AND B.DEL_YN = 'N'
	</select>
	
	<!-- 위젯 -> 방법론 -->
	<select id="selectMhdlgCnt" resultType="egovMap" parameterType="map">
		/* CommonBoardMapper.selectMhdlgCnt */
		SELECT (SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B
		 ON B.MHDLG_MGNO = A.MHDLG_MGNO AND B.MHDLG_DGR = A.PRCS_DGR 
		 WHERE B.APLY_CL_CD = 'MAC0001'AND B.INST_MGNO = #{instMgno}) as BFR_APLY
	  ,(SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B 
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		   AND B.MHDLG_DGR = A.PRCS_DGR
		 WHERE B.PRCS_TYPE_CD = 'MPT0002'
		   AND B.INST_MGNO = #{instMgno}  ) as rvw
	  ,(SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B 
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		   AND B.MHDLG_DGR = A.PRCS_DGR 
		 WHERE B.PRCS_TYPE_CD = 'MPT0012'
		   AND B.INST_MGNO = #{instMgno}) as DLBR_APLY
	  ,(SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO
		 WHERE B.MHDLG_DGR = A.VLD_MHDLG_DGR 
		   AND B.VLD_YN = 'Y'
		   AND B.INST_MGNO = #{instMgno}) as aprv
	</select>
	
	<!-- 메인화면 위젯 -> 로그인 전 방법론 -->
	<select id="selectMainMhdlgCnt" resultType="egovMap">
		/* CommonBoardMapper.selectMainMhdlgCnt */
		SELECT (SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B
		 ON B.MHDLG_MGNO = A.MHDLG_MGNO AND B.MHDLG_DGR = A.PRCS_DGR 
		 WHERE B.APLY_CL_CD = 'MAC0001') as BFR_APLY
	  ,(SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B 
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		   AND B.MHDLG_DGR = A.PRCS_DGR
		 WHERE B.PRCS_TYPE_CD = 'MPT0002') as rvw
	  ,(SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B 
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		   AND B.MHDLG_DGR = A.PRCS_DGR 
		 WHERE B.PRCS_TYPE_CD = 'MPT0012') as DLBR_APLY
	  ,(SELECT COUNT(*)
		  FROM MHDLG_BSC A
		 INNER JOIN MHDLG_DTL B
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO
		 WHERE B.MHDLG_DGR = A.VLD_MHDLG_DGR 
		   AND B.VLD_YN = 'Y') as aprv
	</select>
	
	<!-- 메인화면 위젯 -> 사업 -->
	<select id="selectBizCnt" resultType="egovMap">
		/* CommonBoardMapper.selectBizCnt */
		SELECT ( SELECT COUNT(*)
			     FROM IRB_BSC A 
			     INNER JOIN IRB_DTL B
			     ON B.BIZ_MGNO = A.BIZ_MGNO AND B.BIZ_DGR = A.PRCS_DGR 
			     WHERE B.APLY_CL_CD ='APC0001'
			     AND EXISTS ( SELECT BIZ_MGNO 
		                  FROM IRB_EXCR_DTL 
		                 WHERE 1=1
		                   AND BIZ_MGNO = B.BIZ_MGNO 
		                   AND BIZ_DGR = B.BIZ_DGR 
		                   AND INST_MGNO = #{instMgno} 
		                   AND DEL_YN = 'N')
			     ) BFR_APLY
			, ( SELECT COUNT(*)
			     FROM IRB_BSC A 
		 	     INNER JOIN IRB_DTL B
			     ON B.BIZ_MGNO = A.BIZ_MGNO AND B.BIZ_DGR = A.PRCS_DGR 
			     WHERE B.APLY_CL_CD = 'APC0001'
			     AND B.PRCS_TYPE_CD = 'PTC0003'
			      AND EXISTS ( SELECT BIZ_MGNO 
		                  FROM IRB_EXCR_DTL 
		                 WHERE 1=1
		                   AND BIZ_MGNO = B.BIZ_MGNO 
		                   AND BIZ_DGR = B.BIZ_DGR 
		                   AND INST_MGNO = #{instMgno} 
		                   AND DEL_YN = 'N')
			     ) EVL
			, ( SELECT COUNT(*)
			     FROM IRB_BSC A 
			 INNER JOIN IRB_DTL B
			    ON B.BIZ_MGNO = A.BIZ_MGNO 
			   AND B.BIZ_DGR = A.PRCS_DGR 
			 WHERE B.APLY_CL_CD = 'APC0001' 
			   AND B.PRCS_TYPE_CD = 'PTC0012'
			   AND EXISTS ( SELECT BIZ_MGNO 
		                  FROM IRB_EXCR_DTL 
		                 WHERE 1=1
		                   AND BIZ_MGNO = B.BIZ_MGNO 
		                   AND BIZ_DGR = B.BIZ_DGR 
		                   AND INST_MGNO = #{instMgno} 
		                   AND DEL_YN = 'N')
			   ) DLBR_APLY
				, (SELECT COUNT(*)
			  FROM IRB_BSC A
			 INNER JOIN IRB_DTL B  
			    ON B.BIZ_MGNO = A.BIZ_MGNO 
			   AND B.BIZ_DGR = A.VLD_BIZ_DGR
			 WHERE B.APLY_CL_CD = 'APC0001'
			 AND A.BIZ_RTRCN_YN != 'Y'
			 AND EXISTS ( SELECT BIZ_MGNO 
		                  FROM IRB_EXCR_DTL 
		                  WHERE 1=1
		                  AND BIZ_MGNO = B.BIZ_MGNO 
		                  AND BIZ_DGR = B.BIZ_DGR 
		                  AND INST_MGNO = #{instMgno} 
		                  AND DEL_YN = 'N')
			 ) APRV
	</select>
	
	<!-- 메인화면 위젯 -> 로그인 전 사업 -->
	<select id="selectMainBizCnt" resultType="egovMap">
		/* CommonBoardMapper.selectMainBizCnt */
		SELECT ( SELECT COUNT(*)
			     FROM IRB_BSC A 
			     INNER JOIN IRB_DTL B
			     ON B.BIZ_MGNO = A.BIZ_MGNO AND B.BIZ_DGR = A.PRCS_DGR 
			     WHERE B.APLY_CL_CD ='APC0001'
			     )  BFR_APLY
			, ( SELECT COUNT(*)
			     FROM IRB_BSC A 
		 	     INNER JOIN IRB_DTL B
			     ON B.BIZ_MGNO = A.BIZ_MGNO AND B.BIZ_DGR = A.PRCS_DGR 
			     WHERE B.APLY_CL_CD = 'APC0001'
			     AND B.PRCS_TYPE_CD = 'PTC0003'
			     ) EVL
			, ( SELECT COUNT(*)
			     FROM IRB_BSC A 
			 INNER JOIN IRB_DTL B
			    ON B.BIZ_MGNO = A.BIZ_MGNO 
			   AND B.BIZ_DGR = A.PRCS_DGR 
			 WHERE B.APLY_CL_CD = 'APC0001' 
			   AND B.PRCS_TYPE_CD = 'PTC0012') DLBR_APLY
				, (SELECT COUNT(*)
			  FROM IRB_BSC A
			 INNER JOIN IRB_DTL B  
			    ON B.BIZ_MGNO = A.BIZ_MGNO 
			   AND B.BIZ_DGR = A.VLD_BIZ_DGR
			 WHERE B.APLY_CL_CD = 'APC0001'
			 AND A.BIZ_RTRCN_YN != 'Y') APRV
	</select>
</mapper>