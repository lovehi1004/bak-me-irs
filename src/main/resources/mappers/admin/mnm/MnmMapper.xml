<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.me.irs.admin.mnm.mapper.MnmMapper">
	
	<!-- 메뉴기본 목록조회 --><!-- ROOT 포함시 [NOT W.CYC] 로 조회, 제외시 [W.MENU_LVL > 0] 으로 조회 -->
	<select id="selectMenuList" resultType="egovMap" parameterType="map">
		/* MnmMapper.selectMenuList */
		<include refid="gov.me.irs.common.TreeMenuMapper.treeMenuSql" />
		SELECT W.MENU_MGNO
			 , W.UP_MENU_MGNO
			 , W.MENU_CL_CD
			 , W.MENU_NM
			 , W.MENU_EXPLN
			 , W.MENU_URL_ADDR
			 , W.EXPSR_YN
			 , W.POPUP_YN
			 , W.MENU_LVL
			 , W.SORT_SEQO
			 , W.SYS_CL_CD
			 , ARRAY_TO_STRING(W.PTH, '.') AS PTH					<!-- MENU_MGNO경로 -->
			 , ARRAY_TO_STRING(W.MENU_PATH, ' > ') AS MENU_PATH		<!-- 메뉴경로 -->
		  FROM WITH_MENU_LIST W
		 WHERE W.MENU_LVL > 0
		 ORDER BY W.PTH
	</select>
	
	<!-- 메뉴기본 상세조회 -->
	<select id="selectMenu" resultType="egovMap" parameterType="map">
		/* MnmMapper.selectMenu */
		SELECT MENU_MGNO
			 , UP_MENU_MGNO
			 , MENU_CL_CD
			 , MENU_NM
			 , MENU_EXPLN
			 , MENU_URL_ADDR
			 , EXPSR_YN
			 , POPUP_YN
			 , MENU_LVL
			 , SORT_SEQO
			 , USE_YN
			 , SYS_CL_CD
			 , RGTR_ID
			 , TO_CHAR(R.REG_DT, 'yyyyMMddHHmmss') AS REG_DT
			 , MDFR_ID
			 , TO_CHAR(R.MDFCN_DT, 'yyyyMMddHHmmss') AS MDFCN_DT
		  FROM irsuser.MENU_BSC
		 WHERE MENU_MGNO = #{menuId}
	</select>
	
	<!-- 상위메뉴 메뉴구분정보 수정 -->
	<update id="updateUpMenuSeCd" parameterType="map">
		/* MnmMapper.updateUpMenuSeCd */
		UPDATE irsuser.MENU_BSC
		   SET MENU_CL_CD = #{menuClCd}
			 , EXPSR_YN     = #{expsrYn}
			 , POPUP_YN     = #{popupYn}
			 , MDFR_ID     = #{sessionUserId}
			 , MDFCN_DT     = CURRENT_TIMESTAMP
		 WHERE MENU_MGNO = #{upMenuId}
	</update>
	
	<!-- 메뉴기본 등록 -->
	<insert id="insertMenu" parameterType="map">
		/* MnmMapper.insertMenu */
		<selectKey keyProperty="menuId" resultType="string" order="BEFORE">
			/* MnmMapper.insertMenu.selectKey */
			<!-- 총길이 12, 3번째부터 cutting --> 
			SELECT CONCAT( LEFT(#{upMenuId}, 3)
						 , LPAD( CAST(CAST(COALESCE(MAX(SUBSTRING(MENU_MGNO, (3 + 1), 12)), '0') AS INTEGER) + 1 AS TEXT)
							   , 12 - 3
							   , '0'
						   )
				   )
			FROM irsuser.MENU_BSC
			
		</selectKey>
		/* MnmMapper.insertMenu */
		INSERT
		  INTO irsuser.MENU_BSC
		     ( MENU_MGNO
			 , UP_MENU_MGNO
			 , MENU_CL_CD
			 , MENU_NM
			 , MENU_EXPLN
			 , MENU_URL_ADDR
			 , EXPSR_YN
			 , POPUP_YN
			 , MENU_LVL
			 , SORT_SEQO
			 , SYS_CL_CD
			 , USE_YN
			 , RGTR_ID
			 )
			 (SELECT #{menuId}
				   , #{upMenuId}
				   , #{menuClCd}
				   , #{menuNm}
				   , #{menuExpln}
				   , #{menuUrlAddr}
				   , #{expsrYn}
				   , #{popupYn}
				   , #{menuLvl}+1
				   , COALESCE(MAX(SORT_SEQO), 0)+1
				   , #{sysClCd}
				   , #{useYn}
				   , #{sessionUserId}
				FROM irsuser.MENU_BSC
			   WHERE UP_MENU_MGNO = #{upMenuId}
			 )
	</insert>
	
	<!-- 메뉴기본 수정 -->
	<update id="updateMenu" parameterType="map">
		/* MnmMapper.updateMenu */
		UPDATE irsuser.MENU_BSC
		   SET MENU_NM   = #{menuNm}
			 , MENU_EXPLN = #{menuExpln}
			 , MENU_URL_ADDR  = #{menuUrlAddr}
			 , EXPSR_YN = #{expsrYn}
			 , POPUP_YN = #{popupYn}
			 , USE_YN    = #{useYn}
			 , MDFR_ID    = #{sessionUserId}
			 , MDFCN_DT    = CURRENT_TIMESTAMP
		 WHERE UP_MENU_MGNO = #{upMenuId}
		   AND MENU_MGNO = #{menuId}
	</update>
	
	<!-- 메뉴기본 삭제 - 기준점포함, 하위 모두 삭제처리 -->
	<update id="deleteMenu" parameterType="map">
		/* MnmMapper.deleteMenu */
		<include refid="gov.me.irs.common.TreeMenuMapper.treeMenuSql" />
		UPDATE irsuser.MENU_BSC M
		   SET M.DEL_YN   = 'Y'
			 , M.MDFR_ID   = #{sessionUserId}
			 , M.MDFCN_DT   = CURRENT_TIMESTAMP
			 , M.SORT_SEQO  = -1				/* 삭제시 최소값 설정 */
		 WHERE M.MENU_MGNO IN (SELECT W.MENU_MGNO
							   FROM WITH_MENU_LIST W
							  WHERE W.MENU_LVL > 0)
	</update>
	
</mapper>
