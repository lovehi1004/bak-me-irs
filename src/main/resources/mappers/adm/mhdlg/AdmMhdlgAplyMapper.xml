<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.me.irs.adm.mhdlg.mapper.AdmMhdlgAplyMapper">
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론목록조회 총건수 조회 -->
	<select id="selectMhdlgAplyListCnt" resultType="int" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyListCnt */
		SELECT COUNT(*)
		  FROM irsuser.MHDLG_BSC MB
		 INNER JOIN irsuser.MHDLG_DTL MD
			ON MD.MHDLG_MGNO = MB.MHDLG_MGNO
		   AND MD.MHDLG_DGR = MB.PRCS_DGR 
		 INNER JOIN irsuser.INST_BSC IB                    /* 업체 */
			ON IB.INST_MGNO = MD.INST_MGNO
		 WHERE MB.DEL_YN = 'N'
		   AND MD.DEL_YN = 'N'
		   AND MD.PRCS_TYPE_CD != 'MPT0001'
		<if test="srhAplyClCd != null and !srhAplyClCd.equals('')">
		   AND MD.APLY_CL_CD = #{srhAplyClCd}
		</if>
		<if test="srhMhdlgPrcndTypeCd != null and !srhMhdlgPrcndTypeCd.equals('')">
		   AND MB.REG_RSN_CD = #{srhMhdlgPrcndTypeCd}
		</if>
		<if test="srhAddDataYn != null and !srhAddDataYn.equals('')">
		   AND COALESCE(MD.ADD_DATA_TYPE_CD, '') != ''
		</if>
		<if test="srhInstMngNo != null and !srhInstMngNo.equals('')">
		   AND MD.CMPTNC_INST_NO = #{srhInstMngNo}
		</if>
		<if test="srhPrcsTypeCd != null and !srhPrcsTypeCd.equals('')">
		   AND MD.PRCS_TYPE_CD = #{srhPrcsTypeCd}
		</if>
		<if test="srhMhdlgNm != null and !srhMhdlgNm.equals('')">
		   AND MD.MHDLG_ORGT_NM LIKE CONCAT('%', #{srhMhdlgNm}, '%')		
		    OR MD.MHDLG_KRN_NM LIKE CONCAT('%', #{srhMhdlgNm}, '%')		
		</if>												
		<if test="srhBizFldCd != null and !srhBizFldCd.equals('')">
		   AND EXISTS ( SELECT 1
						  FROM irsuser.MHDLG_FLD_DTL SMFD
						 WHERE SMFD.MHDLG_MGNO = MD.MHDLG_MGNO
						   AND SMFD.MHDLG_DGR = MD.MHDLG_DGR
						   AND SMFD.BIZ_FLD_CD_MGNO = LTRIM(#{srhBizFldCd},'0')
		<if test="srhBizDtlsFldCd != null and !srhBizDtlsFldCd.equals('')">
		   				   AND SMFD.BIZ_FLD_DTLS_CD_MGNO = #{srhBizDtlsFldCd} 
		</if>
					 )
		</if>
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론목록조회 -->
	<select id="selectMhdlgAplyList" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyList */
		SELECT '' as CHK
			 , UU.RNN					  													/* 순번 */
	 		 , UU.MHDLG_MGNO			  													/* 방법론 관리번호 */
	 		 , CAST(UU.MHDLG_DGR AS NUMERIC)				  								/* 방법론 차수 */
	 		 , UU.APLY_CL_CD            													/* 신청구분코드 */
	 		 , irsuser.FN_GET_CODENM('MHDLG_APLY_CL_CD', UU.APLY_CL_CD)	AS APLY_TYPE_NM		/* 신청구분명 */
	 		 , UU.AGREE_CLAUS_CD															/* 협정조항코드 */
	 		 , irsuser.FN_GET_CODENM('AGREE_CLAUS_CD', UU.AGREE_CLAUS_CD) AS AGREE_CLAUS_NM	/* 협정조항명 */
	 		 , UU.INST_MGNO				  													/* 기관 관리번호 - 신청기관*/
	 		 , UU.BZENT_NM				 							 						/* 기관명 - 신청기관 */ 
	 		 , UU.CMPTNC_INST_NO		 													/* 관할기관번호 - 관장기관 */ 
	 		 , UU.GOV_BZENT_NM		      													/* 관할기관명  - 관장기관 */
	 		 , UU.APLY_YMD                													/* 신청일자 */
	 		 , UU.MHDLG_KRN_NM            													/* 방법론 한글명 */
	 		 , UU.MHDLG_ORGT_NM            													/* 방법론 원문명 */
	 		 , UU.MHDLG_UNQNO            													/* 방법론 고유번호 */
			 , UU.VLD_BGNG_YMD            													/* 유효시작일 */	 		 
			 , UU.PRCS_TYPE_CD            													/* 처리유형코드 */
			 , irsuser.FN_GET_CODENM('MHDLG_PRCS_TYPE_CD',UU.PRCS_TYPE_CD) AS	PRCS_TYPE_NM		/* 처리유형코드명 */
			 , UU.REG_RSN_CD            													/* 제정/개정 */
			 , irsuser.FN_GET_CODENM('MHDLG_PRCND_TYPE_CD',UU.REG_RSN_CD) AS REG_RSN_NM		/* 제정/개정 명 */
			 , UU.ADD_DATA_TYPE_CD            												/* 추가자료유형코드 */
			 , CASE WHEN ARRAY_LENGTH(UU.MHDLG_FLD_ARRAY, 1) > 1 THEN ARRAY_TO_STRING(UU.MHDLG_FLD_ARRAY,  E'\n')
			        ELSE UU.MHDLG_FLD_ARRAY[1]
			   END AS MHDLG_FLD_LIST_TEXT
			 , CASE WHEN ARRAY_LENGTH(UU.MHDLG_FLD_ARRAY, 1) > 1 THEN ARRAY_TO_STRING(UU.MHDLG_FLD_ARRAY,  ' ')
			        ELSE UU.MHDLG_FLD_ARRAY[1]
			   END AS MHDLG_FLD_LIST_TEXT2
			 , CASE WHEN DLBR_WRITE_YN = 'Y' THEN
			 		CASE WHEN UU.PRCS_TYPE_CD = 'MPT0002' AND (UU.APLY_TYPE_CD = 'ATC0001' OR UU.APLY_TYPE_CD = 'ATC0002' OR UU.APLY_TYPE_CD = 'ATC0003') AND UU.APLY_CL_CD = 'MAC0001' THEN '검토'
						 WHEN UU.PRCS_TYPE_CD = 'MPT0002' AND (UU.APLY_TYPE_CD = 'ATC0001' OR UU.APLY_TYPE_CD = 'ATC0002' OR UU.APLY_TYPE_CD = 'ATC0003') AND (UU.APLY_CL_CD = 'MAC0002' OR UU.APLY_CL_CD = 'MAC0004') THEN '사전심의'
						 WHEN UU.PRCS_TYPE_CD = 'MPT0002' AND (UU.APLY_TYPE_CD = 'ATC0004' OR UU.APLY_TYPE_CD = 'ATC0005')THEN '심의중'
						 WHEN UU.PRCS_TYPE_CD = 'MPT0002' AND (UU.APLY_TYPE_CD = 'ATC0004' OR UU.APLY_TYPE_CD = 'ATC0005')THEN '심의중'
						 WHEN UU.PRCS_TYPE_CD = 'MPT0008' OR UU.PRCS_TYPE_CD = 'MPT0011' THEN '사전심의'
						 WHEN UU.PRCS_TYPE_CD = 'MPT0012' THEN '심의요청'
						 WHEN UU.PRCS_TYPE_CD = 'MPT0013' THEN '심의대기'
						 WHEN UU.PRCS_TYPE_CD = 'MPT0014' OR UU.PRCS_TYPE_CD = 'MPT0020' THEN '심의중'
						 ELSE '조회'
					 END
					ELSE '조회'  
	 		   END AS BTN_NM 
	 		 , CASE WHEN UU.ADD_DATA_TYPE_CD = 'ADT0001' THEN '진행중'
	 		 		WHEN UU.ADD_DATA_TYPE_CD = 'ADT0002' THEN '자료확인'
	 		 		WHEN UU.ADD_DATA_DMND_PSBLTY_YN = 'Y' THEN '자료요청'
	 		 		ELSE ''
	 		   END AS ADD_DATA_BTN_NM 
	 		 , UU.ADD_DATA_DMND_PSBLTY_YN
	 		 , CAST(COALESCE((SELECT MAX(ADD_DATA_DGR) FROM IRSUSER.MHDLG_ADD_DATA_DTL WHERE MHDLG_MGNO = UU.MHDLG_MGNO), 0) AS TEXT ) AS ADD_DATA_DGR
	 		 , CASE WHEN UU.DATA_DGR <![CDATA[>]]> 0 THEN
		 		    CASE WHEN UU.TYPE_CD = 'DTC0001' THEN '보완' || UU.DATA_DGR || '차'
		 		 		 WHEN UU.TYPE_CD = 'DTC0002' THEN '보완(심의)' || UU.DATA_DGR || '차'
		 		 		 ELSE ''
		 		 	END
		 		 	ELSE ''
	 		   END AS TYPE_CD_NM
		  FROM (
            	 SELECT VV.RNN
            		  , VV.MHDLG_MGNO
            		  , VV.MHDLG_DGR        
            		  , VV.INST_MGNO        
            		  , VV.CMPTNC_INST_NO   
            		  , VV.APLY_YMD         
            		  , VV.MHDLG_KRN_NM     
            		  , VV.MHDLG_ORGT_NM     
            		  , VV.APLY_CL_CD   
            		  , VV.AGREE_CLAUS_CD     
            		  , VV.VLD_BGNG_YMD     
            		  , VV.REG_RSN_CD     
            		  , VV.MHDLG_UNQNO     
            		  , VV.PRCS_TYPE_CD     
            		  , VV.ADD_DATA_TYPE_CD     
            		  , VV.REG_DT
            		  , VV.ADD_DATA_DMND_PSBLTY_YN
            		  , VV.BZENT_NM
            		  , GIB.BZENT_NM AS GOV_BZENT_NM
            		  , VV.TYPE_CD
            		  , VV.DATA_DGR
            		  , VV.APLY_TYPE_CD
            		  , (
                         SELECT ARRAY_AGG(X.MHDLG_FLD)
                           FROM (
                                 SELECT
                                        CASE WHEN Z.MHDLG_FLD_TOTAL_CNT = 1 THEN Z.MHDLG_FLD                        	/* 1건이면 문자만 출력 */
                                             ELSE '(' || MHDLG_FLD_ROWNUM || ') ' || Z.MHDLG_FLD                	    /* 2건이상이면 앞에 (1) 숫자 붙이기 */
                                        END AS MHDLG_FLD
                                   FROM
                                        (
                                         SELECT GRP_CD.BIZ_FLD_KORN_NM || ' - ' || DTL_CD.BIZ_DTLS_FLD_KORN_NM AS MHDLG_FLD
                                              , ROW_NUMBER() OVER(PARTITION BY MFD.MHDLG_MGNO, MFD.MHDLG_DGR ORDER BY DTL_CD.BIZ_FLD_DTLS_CD_MGNO) AS MHDLG_FLD_ROWNUM
                                              , COUNT(*) OVER() MHDLG_FLD_TOTAL_CNT
                                           FROM irsuser.MHDLG_FLD_DTL MFD                            					 /* 방법론 사업세부분야 */
                                          INNER JOIN irsuser.COM_BIZ_FLD_BSC GRP_CD
                                             ON GRP_CD.BIZ_FLD_CD_MGNO = MFD.BIZ_FLD_CD_MGNO
                                          INNER JOIN irsuser.COM_BIZ_FLD_DTL DTL_CD
                                             ON DTL_CD.BIZ_FLD_DTLS_CD_MGNO = MFD.BIZ_FLD_DTLS_CD_MGNO
                                          WHERE MFD.MHDLG_MGNO = VV.MHDLG_MGNO
                                            AND MFD.MHDLG_DGR = VV.MHDLG_DGR
                                        ) Z
                                ) X
                        ) AS MHDLG_FLD_ARRAY                                                                  	 		 /* 방법론 분야정보 - 배열로 조립하기 */
                      , (SELECT CASE WHEN VV.cmptnc_inst_no = A.inst_mgno        /* 관장기관 */ 
   										OR VV.cmptnc_inst_no = A.up_inst_mgno    /* 상위기관 */
	   									OR A.user_cl_cd = 'UCC0001' THEN 'Y'  /* 전체관리자 */
									 ELSE 'N'
								END AS DLBR_WRITE_YN
						   FROM irsuser.user_bsc A
						  WHERE A.USER_ID = #{sUserId}) AS DLBR_WRITE_YN
              	   FROM (
                   		 SELECT U.TOTAL_CNT - U.RN + 1 AS RNN
                    	 	  , U.MHDLG_MGNO
                    	 	  , U.MHDLG_DGR        
                    	 	  , U.INST_MGNO        
                    	 	  , U.CMPTNC_INST_NO   
                    	 	  , U.APLY_YMD         
                    	 	  , U.MHDLG_KRN_NM     
                    	 	  , U.MHDLG_ORGT_NM     
                    	 	  , U.APLY_CL_CD     
                    	 	  , U.AGREE_CLAUS_CD     
                    	 	  , U.VLD_BGNG_YMD     
                    	 	  , U.REG_RSN_CD     
                    	 	  , U.MHDLG_UNQNO     
                    	 	  , U.PRCS_TYPE_CD     
                    	 	  , U.ADD_DATA_TYPE_CD     
                    	 	  , U.REG_DT
                    	 	  , U.ADD_DATA_DMND_PSBLTY_YN
                    	 	  , U.BZENT_NM 
                    	 	  , U.TYPE_CD
                    	 	  , U.DATA_DGR
                    	 	  , U.APLY_TYPE_CD
                          FROM (
				                                SELECT ROW_NUMBER() OVER( ORDER BY MB.MHDLG_MGNO DESC) AS RN
				                            		 , COUNT(*) OVER() AS TOTAL_CNT 
                                                     , MB.MHDLG_MGNO
                                                     , MD.MHDLG_DGR
                                                     , MD.INST_MGNO                 /* 기관관리번호 - 업체명 */
                                                     , MD.CMPTNC_INST_NO        	/* 관할기관번호 - 관장기관 */
                                                     , MD.APLY_YMD                	/* 신청일자 */
                                                     , MD.MHDLG_KRN_NM            	/* 방법론 한글명 */
                                                     , MD.MHDLG_ORGT_NM            	/* 방법론 원문명 */
                                                     , MD.APLY_CL_CD            	/* 신청구분코드 */
                                                     , MD.AGREE_CLAUS_CD 			/* 협정조항코드 */
                                                     , MD.VLD_BGNG_YMD            	/* 유효시작일 */
                                                     , MB.REG_RSN_CD				/* 제정/개정 */
                                                     , MB.MHDLG_UNQNO				/* 방법론 고유번호 */
                                                     , MD.PRCS_TYPE_CD				/* 처리유형코드 */
                                                     , MD.ADD_DATA_TYPE_CD			/* 추가자료유형코드 */
                                                     , MD.REG_DT                	/* 등록일자 */
                                                     , MB.ADD_DATA_DMND_PSBLTY_YN
                                                     , IB.BZENT_NM 
                                                     , MB.TYPE_CD
                                                     , MB.DATA_DGR
                                                     , MD.APLY_TYPE_CD
                                                  FROM irsuser.MHDLG_BSC MB
                                                 INNER JOIN irsuser.MHDLG_DTL MD
                                                 	ON MD.MHDLG_MGNO = MB.MHDLG_MGNO
                                                   AND MD.MHDLG_DGR = MB.PRCS_DGR 
                                                 INNER JOIN irsuser.INST_BSC IB                    /* 업체 */
                                                 	ON IB.INST_MGNO = MD.INST_MGNO
                                                 WHERE MB.DEL_YN = 'N'
                                                   AND MD.DEL_YN = 'N'
                                                   AND MD.PRCS_TYPE_CD != 'MPT0001'
												<if test="srhAplyClCd != null and !srhAplyClCd.equals('')">
                                                   AND MD.APLY_CL_CD = #{srhAplyClCd}
												</if>
												<if test="srhAddDataYn != null and !srhAddDataYn.equals('')">
                                                   AND COALESCE(MD.ADD_DATA_TYPE_CD, '') != ''
												</if>
												<if test="srhMhdlgPrcndTypeCd != null and !srhMhdlgPrcndTypeCd.equals('')">
                                                   AND MB.REG_RSN_CD = #{srhMhdlgPrcndTypeCd}
												</if>
												<if test="srhPrcsTypeCd != null and !srhPrcsTypeCd.equals('')">
                                                   AND MD.PRCS_TYPE_CD = #{srhPrcsTypeCd}
												</if>
												<if test="srhInstMngNo != null and !srhInstMngNo.equals('')">
												   AND MD.CMPTNC_INST_NO = #{srhInstMngNo}
												</if>
												<if test="srhMhdlgNm != null and !srhMhdlgNm.equals('')">
                                                   AND MD.MHDLG_ORGT_NM LIKE CONCAT('%', #{srhMhdlgNm}, '%')		
                                                    OR MD.MHDLG_KRN_NM LIKE CONCAT('%', #{srhMhdlgNm}, '%')		
												</if>												
												<if test="srhBizFldCd != null and !srhBizFldCd.equals('')">
                                                   AND EXISTS ( SELECT 1
                                                                  FROM irsuser.MHDLG_FLD_DTL SMFD
                                                                 WHERE SMFD.MHDLG_MGNO = MD.MHDLG_MGNO
                                                                   AND SMFD.MHDLG_DGR = MD.MHDLG_DGR
                                                                   AND SMFD.BIZ_FLD_CD_MGNO = LTRIM(#{srhBizFldCd},'0')
                                                <if test="srhBizDtlsFldCd != null and !srhBizDtlsFldCd.equals('')">
                                                                   AND SMFD.BIZ_FLD_DTLS_CD_MGNO = #{srhBizDtlsFldCd} 
												</if>
                                                 			   )
                                                 
												</if>
                              			 ) U
	                     LIMIT #{pageNavigation.listSize}
						OFFSET (#{pageNavigation.pageNo} - 1) * #{pageNavigation.listSize}
        
                    ) VV
             	   LEFT OUTER JOIN irsuser.INST_BSC GIB            /* 관장기관 */
                	 ON GIB.INST_MGNO = VV.CMPTNC_INST_NO
                  ORDER BY VV.RNN DESC
		  	 ) UU
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론상세조회 -->
	<select id="selectMhdlgAplyDetail" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyDetail */
		SELECT A.MHDLG_MGNO
			 , A.MHDLG_GROUP_MGNO
			 , CAST(A.RVSN_DGR AS TEXT) 
			 , A.REG_RSN_CD
			 , irsuser.FN_GET_CODENM('MHDLG_PRCND_TYPE_CD', A.REG_RSN_CD) AS REG_RSN_CD_NM
			 , A.MHDLG_UNQNO
			 , A.TYPE_CD
		--	 , irsuser.FN_GET_CODENM('', A.TYPE_CD)
			 , CAST(A.DATA_DGR AS TEXT) AS DATA_DGR
			 , CAST(A.PRCS_DGR AS TEXT)
			 , CAST(B.MHDLG_DGR AS TEXT)
			 , B.DGR_REG_RSN_CD
		--	 , irsuser.FN_GET_CODENM('', B.DGR_REG_RSN_CD) AS DGR_REG_RSN_CD_NM
			 , B.VLD_YN
			 , B.VLD_YMD
			 , B.INST_MGNO
			 , B.USER_ID
			 , B.APLY_CL_CD
			 , irsuser.FN_GET_CODENM('MHDLG_APLY_CL_CD', B.APLY_CL_CD) AS APLY_CL_CD_NM
			 , B.AGREE_CLAUS_CD
			 , irsuser.FN_GET_CODENM('AGREE_CLAUS_CD', B.AGREE_CLAUS_CD) AS AGREE_CLAUS_CD_NM
			 , B.MHDLG_ORGT_NM
			 , B.MHDLG_KRN_NM
			 , B.VLD_BGNG_YMD
			 , B.PRPSD_FLMNO
			 , B.BIZ_PLND_FLMNO
			 , B.ETC_DATA_FLMNO
			 , B.EXPLN_FLMNO
			 , B.CMPTNC_INST_NO
			 , B.APLY_TYPE_CD
		--	 , irsuser.FN_GET_CODENM('', B.APLY_TYPE_CD) AS APLY_TYPE_CD_NM
			 , B.APLY_YMD
			 , B.PRCS_TYPE_CD
			 , irsuser.FN_GET_CODENM('MHDLG_PRCS_TYPE_CD', B.PRCS_TYPE_CD) AS PRCS_TYPE_CD_NM
			 , B.PRCS_YMD
			 , B.ADD_DATA_TYPE_CD
		--	 , irsuser.FN_GET_CODENM('',B.ADD_DATA_TYPE_CD) AS ADD_DATA_TYPE_CD_NM
			 , B.ADD_DATA_PRCS_YMD 
			 , CAST(B.RVW_SN AS TEXT)
			 , CAST(B.DIC_DLBR_SN AS TEXT)
			 , CAST(B.DLBR_SN AS TEXT)
 			 , CASE WHEN B.REDD_PLUS_YN = 'N' THEN '무'
			 		ELSE '유'
			   END AS REDD_PLUS_YN
		  FROM irsuser.MHDLG_BSC A
		 INNER JOIN irsuser.MHDLG_DTL B 
			ON B.MHDLG_MGNO  = A.MHDLG_MGNO 
		 WHERE 1=1
		  AND B.MHDLG_MGNO  = #{mhdlgMgno}
		  AND B.MHDLG_DGR  = CAST(#{mhdlgDgr} AS NUMERIC)
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 검토결과등록 -->
	<insert id="insertMhdlgAplyRvwRslt" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyRvwRslt */
		<selectKey order="BEFORE" resultType="String" keyProperty="rvwSn">
			SELECT NEXTVAL('IRSUSER.MHDLG_RVW_SN_SEQ')
		</selectKey>
		INSERT
		  INTO irsuser.MHDLG_RVW_DTL
			 ( RVW_SN
			 , MHDLG_MGNO
			 , RVW_DGR
			 , RVW_INST_CD
			 , RVWR_ID
			 , RVW_TYPE_CD
			 , RVW_DT
			 , RVW_OPNN
			 , RVW_FLMNO
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
			 ( CAST(#{rvwSn} AS NUMERIC)
			 , #{mhdlgMgno}
			 , 1
			 , #{rvwInstCd}
			 , #{sUserId}
			 , #{rvwTypeCd}
			 , CURRENT_TIMESTAMP
			 , #{rvwOpnn}
			 , #{rvwFlmno}
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 검토결과조회 -->
	<select id="selectMhdlgAplyRvwRslt" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyRvwRslt */
		SELECT B.RVW_SN
	 		 , B.MHDLG_MGNO
			 , B.RVW_DGR
			 , (B.RVW_DGR || '차') AS RVW_DGR_NM
			 , B.RVW_INST_CD
			 , B.RVWR_ID
			 , B.RVW_TYPE_CD
			 , irsuser.FN_GET_CODENM('MHDLG_RVW_TYPE_CD', B.RVW_TYPE_CD) AS RVW_TYPE_CD_NM
			 , B.RVW_TYPE_CD
			 , TO_CHAR(B.RVW_DT,'yyyy-MM-dd') as RVW_DT
			 , B.RVW_OPNN
			 , B.RVW_FLMNO
		  FROM irsuser.MHDLG_DTL A
		 INNER JOIN irsuser.MHDLG_RVW_DTL B 
			ON B.MHDLG_MGNO  = A.MHDLG_MGNO
		   AND B.RVW_SN = A.RVW_SN
		 WHERE A.mhdlg_mgno = #{mhdlgMgno}
		   AND A.mhdlg_dgr  = CAST(#{mhdlgDgr} AS NUMERIC)
		 ORDER BY B.RVW_DGR DESC
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 사전심의결과등록 -->
	<insert id="insertMhdlgAplyDicDlbrRslt" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyDicDlbrRslt */
		INSERT
		  INTO irsuser.MHDLG_DIC_DLBR_DTL
			 ( DIC_DLBR_SN
			 , DIC_DLBR_DGR
			 , MHDLG_MGNO
			 , DIC_DLBR_TYPE_CD
			 , DIC_DLBR_DT
			 , DIC_DLBR_INST_CD
			 , DIC_DLBRR_ID
			 , DIC_DLBR_OPNN
			 , DIC_DLBR_FLMNO
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
			 ( CAST (#{dicDlbrSn} AS NUMERIC)
			 , CAST (#{dicDlbrDgr} AS NUMERIC)
			 , #{mhdlgMgno}
			 , #{dicDlbrTypeCd}
			 , CURRENT_TIMESTAMP
			 , #{dicDlbrInstCd}
			 , #{sUserId}
			 , #{dicDlbrOpnn}
			 , #{dicDlbrFlmno}
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 사전심의결과등록 -->
	<insert id="insertNewMhdlgAplyDicDlbrRslt" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyDicDlbrRslt */
		<selectKey order="BEFORE" resultType="String" keyProperty="dicDlbrSn">
			SELECT NEXTVAL('IRSUSER.MHDLG_DIC_DLBR_SN_SEQ')	
		</selectKey>
		INSERT
		  INTO irsuser.MHDLG_DIC_DLBR_DTL
			 ( DIC_DLBR_SN
			 , DIC_DLBR_DGR
			 , MHDLG_MGNO
			 , DIC_DLBR_TYPE_CD
			 , DIC_DLBR_DT
			 , DIC_DLBR_INST_CD
			 , DIC_DLBRR_ID
			 , DIC_DLBR_OPNN
			 , DIC_DLBR_FLMNO
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
			 ( CAST (#{dicDlbrSn} AS NUMERIC)
			 , CAST (#{dicDlbrDgr} AS NUMERIC)
			 , #{mhdlgMgno}
			 , #{dicDlbrTypeCd}
			 , CURRENT_TIMESTAMP
			 , #{dicDlbrInstCd}
			 , #{sUserId}
			 , #{dicDlbrOpnn}
			 , #{dicDlbrFlmno}
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 이의신청조회 -->
	<select id="selectMhdlgAplyObjcAply" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyObjcAply */
		SELECT '컬럼정보' AS COL
		  FROM irsuser.TEMP_TABLE
		 WHERE CONDITION = #{condition}
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 사전심의결과조회 -->
	<select id="selectMhdlgAplyDicDlbrRslt" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyDicDlbrRslt */
		SELECT A.DIC_DLBR_SN
			 , CAST(A.DIC_DLBR_DGR AS TEXT)
			 , (A.DIC_DLBR_DGR || '차') AS DIC_DLBR_DGR_NM 
			 , A.MHDLG_MGNO
			 , A.OBJC_APLY_OPNN
			 , A.OBJC_APLY_FLMNO
			 , A.OBJC_APLY_YMD
			 , A.DIC_DLBR_TYPE_CD
			 , irsuser.fn_get_codenm('DIC_DLBR_TYPE_CD',A.DIC_DLBR_TYPE_CD) AS DIC_DLBR_TYPE_CD_NM
			 , TO_CHAR(A.DIC_DLBR_DT,'yyyy-MM-dd') AS DIC_DLBR_DT
			 , A.DIC_DLBR_INST_CD
			 , A.DIC_DLBRR_ID
			 , A.DIC_DLBR_OPNN
			 , A.DIC_DLBR_FLMNO
			 , CASE WHEN A.OBJC_APLY_YMD != '' THEN 'N'
			 		ELSE ''
			 		END AS MOD
		  FROM irsuser.MHDLG_DIC_DLBR_DTL A 
		 INNER JOIN irsuser.MHDLG_DTL B
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		 WHERE B.MHDLG_MGNO = #{mhdlgMgno}
		   AND B.MHDLG_DGR  = CAST(#{mhdlgDgr} AS NUMERIC)
		   AND B.DIC_DLBR_SN = A.DIC_DLBR_SN
		 ORDER BY A.DIC_DLBR_DGR DESC
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 기승인건확인 -->
	<insert id="insertMhdlgAplyAprv" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyAprv */
		INSERT
		  INTO irsuser.TEMP_TABLE
			 ( COL
			 , USE_YN
			 , RGTR_ID
			 )
		VALUES
			 ( #{col}
			 , #{useYn}
			 , #{sessionUserId}
			 )
	</insert>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 심의결과등록 -->
	<insert id="insertMhdlgAplyDlbrRslt" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyDlbrRslt */
		INSERT 
		  INTO irsuser.MHDLG_DLBR_DTL
		     ( DLBR_SN
			 , DLBR_DGR
			 , MHDLG_MGNO
			 , OBJC_APLY_OPNN
			 , OBJC_APLY_FLMNO
			 , OBJC_APLY_YMD
			 , DLBR_TYPE_CD
			 , DLBR_DT
			 , DLBR_RSLT_INPT_INST_CD
			 , DLBR_RSLT_RGTR_ID
			 , DLBR_OPNN
			 , DLBR_FLMNO
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
		     ( CAST(#{dlbrSn} AS NUMERIC)
			 , CAST(#{dlbrDgr} AS NUMERIC)
			 , #{mhdlgMgno}
			 , #{objcAplyOpnn}
			 , #{objcAplyFlmno}
			 , #{objcAplyYmd}
			 , #{dlbrTypeCd}
			 , CAST(#{dlbrDt} AS TIMESTAMP) 
			 , #{dlbrRsltInptInstCd}
			 , #{sUserId}
			 , #{dlbrOpnn}
			 , #{dlbrFlmno}
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 심의결과등록 -->
	<insert id="insertNewMhdlgAplyDlbrRslt" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyDlbrRslt */
		<selectKey order="BEFORE" resultType="String" keyProperty="dlbrSn">
			SELECT NEXTVAL('IRSUSER.mhdlg_dlbr_sn_seq')
		</selectKey>
		INSERT 
		  INTO irsuser.MHDLG_DLBR_DTL
		     ( DLBR_SN
			 , DLBR_DGR
			 , MHDLG_MGNO
			 , OBJC_APLY_OPNN
			 , OBJC_APLY_FLMNO
			 , OBJC_APLY_YMD
			 , DLBR_TYPE_CD
			 , DLBR_DT
			 , DLBR_RSLT_INPT_INST_CD
			 , DLBR_RSLT_RGTR_ID
			 , DLBR_OPNN
			 , DLBR_FLMNO
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
		     ( CAST(#{dlbrSn} AS NUMERIC)
			 , CAST(#{dlbrDgr} AS NUMERIC)
			 , #{mhdlgMgno}
			 , #{objcAplyOpnn}
			 , #{objcAplyFlmno}
			 , #{objcAplyYmd}
			 , #{dlbrTypeCd}
			 , CAST(#{dlbrDt} AS TIMESTAMP) 
			 , #{dlbrRsltInptInstCd}
			 , #{sUserId}
			 , #{dlbrOpnn}
			 , #{dlbrFlmno}
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 심의결과조회 -->
	<select id="selectMhdlgAplyDlbrRslt" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyDlbrRslt */
		SELECT A.DLBR_SN
			 , CAST(A.DLBR_DGR AS TEXT)
			 , (A.DLBR_DGR || '차') AS DLBR_DGR_NM 
			 , A.MHDLG_MGNO
			 , A.OBJC_APLY_OPNN
			 , A.OBJC_APLY_FLMNO
			 , A.OBJC_APLY_YMD
			 , A.DLBR_TYPE_CD
			 , irsuser.fn_get_codenm('MHDLG_DLBR_TYPE_CD',A.DLBR_TYPE_CD) AS DLBR_TYPE_CD_NM
			 , TO_CHAR(A.DLBR_DT,'yyyy-MM-dd') AS DLBR_DT
			 , A.DLBR_RSLT_INPT_INST_CD
			 , A.DLBR_RSLT_RGTR_ID
			 , A.DLBR_OPNN
			 , A.DLBR_FLMNO
			 , CASE WHEN A.OBJC_APLY_YMD != '' THEN 'N'
			 		ELSE ''
			 		END AS MOD
		  FROM irsuser.MHDLG_DLBR_DTL A 
		 INNER JOIN irsuser.MHDLG_DTL B
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		 WHERE B.MHDLG_MGNO = #{mhdlgMgno}
		   AND B.MHDLG_DGR  = CAST(#{mhdlgDgr} AS NUMERIC)
		   AND B.DLBR_SN = A.DLBR_SN
		    <!-- AND A.DLBR_SN  <![CDATA[<=]]> (SELECT DLBR_SN FROM irsuser.mhdlg_dtl WHERE mhdlg_mgno = #{mhdlgMgno} AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)) -->
		 ORDER BY A.DLBR_DGR DESC
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 추가자료요청등록 -->
	<insert id="insertMhdlgAplyAddReq" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyAddReq */
		INSERT INTO irsuser.MHDLG_ADD_DATA_DTL (
			 MHDLG_MGNO
			,MHDLG_DGR
			,ADD_DATA_DGR
			,DATA_DMND_TYPE_CD
			,DATA_DMND_DT
			,DATA_DMND_RSN
			,DATA_DMND_FLMNO
			,DATA_DMND_YN
			,DATA_DMND_INST_CD			
			,DATA_RQSTR_ID
			,DEL_YN
			,RGTR_ID
			,REG_DT			
		) VALUES (
			 #{mhdlgMgno}
			,CAST(#{mhdlgDgr} AS NUMERIC)
			,(SELECT COALESCE(MAX(ADD_DATA_DGR), 0) + 1 FROM irsuser.MHDLG_ADD_DATA_DTL WHERE MHDLG_MGNO = #{mhdlgMgno})
			,#{dataDmndTypeCd}
			,CURRENT_TIMESTAMP
			,#{dataDmndRsn}
			,#{dataDmndFlmno}
			,#{dataDmndYn}
			,(SELECT INST_MGNO FROM irsuser.USER_BSC WHERE USER_ID = #{sUserId})
			,#{sUserId}
			,'N'
			,#{sUserId}
			,CURRENT_TIMESTAMP	
		)
	</insert>
	
	<update id="updateMhdlgAplyAddDtl" parameterType="map">
		UPDATE IRSUSER.MHDLG_DTL 
		   SET ADD_DATA_TYPE_CD = #{addDataTypeCd} 
			 , ADD_DATA_PRCS_YMD = ''
			 , MDFR_ID = #{sUserId} 
			 , MDFCN_DT = CURRENT_TIMESTAMP 	
		 WHERE 1=1
		   AND MHDLG_MGNO = #{mhdlgMgno}
		   AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
	</update>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 추가자료 방법론 상세 조회 -->
	<select id="selectMhdlgAplyDataDmnd" resultType="egovMap" parameterType="map">
		/* BizMhdlgAplyMapper.selectMhdlgAplyDataDmnd */
		SELECT C.BZENT_NM
			 , C.BRNO 
			 , B.APLY_CL_CD
			 , IRSUSER.FN_GET_CODENM('MHDLG_APLY_CL_CD',B.APLY_CL_CD) AS APLY_CL_CD_NM
			 , B.MHDLG_ORGT_NM 
			 , B.MHDLG_KRN_NM 
			 , B.AGREE_CLAUS_CD
			 , IRSUSER.FN_GET_CODENM('AGREE_CLAUS_CD',B.AGREE_CLAUS_CD) AS AGREE_CLAUS_CD_NM
			 , B.MHDLG_MGNO
			 , B.MHDLG_DGR 
			 , B.PRPSD_FLMNO 
			 , B.BIZ_PLND_FLMNO 
			 , B.ETC_DATA_FLMNO
			 , B.ADD_DATA_TYPE_CD 
		  FROM irsuser.MHDLG_BSC A
		 INNER JOIN irsuser.MHDLG_DTL B
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		 INNER JOIN irsuser.INST_BSC C 
		    ON B.INST_MGNO = C.INST_MGNO
		 WHERE B.MHDLG_MGNO = #{mhdlgMgno}
		   AND B.MHDLG_DGR = CAST ( #{mhdlgDgr} AS NUMERIC)
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 추가자료확인조회 -->
	<select id="selectMhdlgAplyDataIdnty" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyDataIdnty */
		SELECT '컬럼정보' AS COL
		  FROM irsuser.TEMP_TABLE
		 WHERE CONDITION = #{condition}
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 추가자료결과등록 -->
	<insert id="insertMhdlgAplyDataRslt" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAplyDataRslt */
		INSERT
		  INTO irsuser.TEMP_TABLE
			 ( COL
			 , USE_YN
			 , RGTR_ID
			 )
		VALUES
			 ( #{col}
			 , #{useYn}
			 , #{sessionUserId}
			 )
	</insert>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 추가자료결과확인 -->
	<select id="selectMhdlgAplyDataRslt" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyDataRslt */
		SELECT '컬럼정보' AS COL
		  FROM irsuser.TEMP_TABLE
		 WHERE CONDITION = #{condition}
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 이력목록조회 -->
	<select id="selectMhdlgAplyHistList" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyHistList */
		SELECT '컬럼정보' AS COL
		  FROM irsuser.TEMP_TABLE
		 WHERE 1 = 1
		 ORDER BY TEMP_SEQ ASC
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 보고서출력 -->
	<select id="selectMhdlgAplyRpt" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyRpt */
		SELECT '컬럼정보' AS COL
		  FROM irsuser.TEMP_TABLE
		 WHERE CONDITION = #{condition}
	</select>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 관장기관변경 -->
	<update id="updateMhdlgAplyInst" parameterType="map">
		/* AdmMhdlgAplyMapper.updateMhdlgAplyInst */
		UPDATE irsuser.TEMP_TABLE
		   SET COL = #{col}
		     , MDFR_ID = #{sessionUserId}
		     , MDFCN_DT = CURRENT_TIMESTAMP
		 WHERE CONDITION = #{condition}
	</update>




		<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론기본등록 -->
	<insert id="insertMhdlgBsc" parameterType="map">
		<selectKey keyProperty="mhdlgMgno" resultType="String" order="BEFORE">
			/* AdmMhdlgAplyMapper.insertMhdlgBsc.selectKey */
			SELECT CONCAT( 'MH'
				 , TO_CHAR(CURRENT_TIMESTAMP, 'yy')
				 , LPAD( CAST(CAST(COALESCE(MAX(SUBSTRING(MHDLG_MGNO, (4 + 1), 10)), '0') AS NUMERIC) + 1 AS TEXT)
					   , 10 - 4
					   , '0'
				   )
		   )
			  FROM irsuser.MHDLG_BSC
		</selectKey>
			/* AdmMhdlgAplyMapper.insertMhdlgBsc */
			INSERT
			  INTO irsuser.MHDLG_BSC
				 ( MHDLG_MGNO			
				 , MHDLG_GROUP_MGNO		
				 , RVSN_DGR			    
				 , REG_RSN_CD
				 , MHDLG_UNQNO
				 , TYPE_CD
				 , DATA_DGR
				 , PRCS_DGR
				 , VLD_MHDLG_DGR
				 , ADD_DATA_DMND_PSBLTY_YN
				 , DEL_YN
				 , RGTR_ID
				 , REG_DT
				 )
			VALUES
				 ( #{mhdlgMgno}
			 <choose>
			 	<when test="mhdlgGroupMgno != null and !mhdlgGroupMgno.equals('')">
				 , #{mhdlgGroupMgno}
			 	</when>
			 	<otherwise>
				 , #{mhdlgMgno}
			 	</otherwise>
			 </choose>
				 , #{rvsnDgr}
				 , #{regRsnCd}
				 , #{mhdlgUnqno}
				 , #{bscTypeCd}
				 , 0
				 , 1
				 , 0
				 , 'N'
				 , 'N'
				 , #{sUserId}
				 , CURRENT_TIMESTAMP
				 )
	</insert>
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론상세등록 -->
	<insert id="insertMhdlgDtl" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgDtl */
		INSERT
		  INTO irsuser.MHDLG_DTL
			 ( MHDLG_MGNO
			 , MHDLG_DGR
			 , DGR_REG_RSN_CD
			 , VLD_YN
			 , VLD_YMD
			 , INST_MGNO
			 , USER_ID
			 , APLY_CL_CD
			 , AGREE_CLAUS_CD
			 , MHDLG_ORGT_NM
			 , MHDLG_KRN_NM
			 , VLD_BGNG_YMD
			 , PRPSD_FLMNO
			 , BIZ_PLND_FLMNO
			 , ETC_DATA_FLMNO
			 , EXPLN_FLMNO
			 , CMPTNC_INST_NO
			 , APLY_TYPE_CD
			 , APLY_YMD
			 , PRCS_TYPE_CD
			 , PRCS_YMD
			 , ADD_DATA_TYPE_CD
			 , ADD_DATA_PRCS_YMD
			 , RVW_SN
			 , DIC_DLBR_SN
			 , DLBR_SN
			 , TYPE_CD
			 , DATA_DGR
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
			 ( #{mhdlgMgno}
			 , #{mhdlgDgr}
			 , #{dgrRegRsnCd}
			 , #{vldYn}
			 , #{vldYmd}
			 , #{instMgno}
			 , #{sUserId}
			 , #{aplyClCd}
			 , #{agreeClausCd}
			 , #{mhdlgOrgtNm}
			 , #{mhdlgKrnNm}
			 , #{vldBgngYmd}
			 , #{prpsdFlmno}
			 , #{bizPlndFlmno}
			 , #{etcDataFlmno}
			 , #{explnFlmno}
			 , #{cmptncInstNo}
			 , #{aplyTypeCd}
		 <choose>
		 	<when test='prcsTypeCd != null and prcsTypeCd.equals("MPT0001")'>
			 , ''
		 	</when>
		 	<otherwise>
			 , TO_CHAR(CURRENT_TIMESTAMP, 'yyyyMMdd')
		 	</otherwise>
		 </choose>			 
			 , #{prcsTypeCd}
			 , TO_CHAR(CURRENT_TIMESTAMP, 'yyyyMMdd')
			 , #{addDataTypeCd}
			 , #{addDataPrcsYmd}
			 , CAST(#{rvwSn} AS NUMERIC)
			 , CAST(#{dicDlbrSn} AS NUMERIC)
			 , CAST(#{dlbrSn} AS NUMERIC)
			 , #{dtlTypeCd}
			 , CAST ( #{dtlDataDgr} AS NUMERIC)
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론협정상세등록 -->
	<insert id="insertMhdlgAgreeDtl" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgAgreeDtl */
		INSERT
		  INTO irsuser.AGREE_STIPL_MHDLG_REL
			 ( MHDLG_MGNO
			 , MHDLG_DGR
			 , CNCLD_MGNO
			 , CNCLD_DGR
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
			 ( #{mhdlgMgno}
			 , CAST(#{mhdlgDgr} AS NUMERIC)
			 , #{cncldMgno}
			 , CAST(#{cncldDgr} AS NUMERIC)
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론분야상세등록 -->
	<insert id="insertMhdlgFldDtl" parameterType="map">
		/* AdmMhdlgAplyMapper.insertMhdlgFldDtl */
		INSERT
		  INTO irsuser.MHDLG_FLD_DTL
			 ( MHDLG_MGNO
			 , MHDLG_DGR
			 , BIZ_FLD_CD_MGNO
			 , BIZ_FLD_DTLS_CD_MGNO
			 , MHDLG_UNQNO
			 , RGTR_ID
			 , REG_DT
			 )
		VALUES
			 ( #{mhdlgMgno}
			 , CAST(#{mhdlgDgr} AS NUMERIC)
			 , #{bizFldCdMgno}
			 , #{bizFldDtlsCdMgno}
			 , #{mhdlgUnqno}
			 , #{sUserId}
			 , CURRENT_TIMESTAMP
			 )
	</insert>

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론기본 테이블 수정 -->
	<update id="updateMhdlgBsc" parameterType="map">
		/* AdmMhdlgAplyMapper.updateMhdlgBsc */
		UPDATE irsuser.MHDLG_BSC
		   SET MDFR_ID = #{sUserId}
		   	 , MDFCN_DT = CURRENT_TIMESTAMP
		   	 , RVSN_DGR = CAST(#{rvsnDgr} AS NUMERIC)
			 , REG_RSN_CD = #{regRsnCd}
			 , MHDLG_UNQNO = #{mhdlgUnqno}
			 <choose>
			 	<when test="bscTypeCd != null and !bscTypeCd.equals('')">
			 , TYPE_CD = #{bscTypeCd}
			 	</when>	
			 </choose>
			 <choose>
			 	<when test="bscDataDgr != null and !bscDataDgr.equals('')">
			 , DATA_DGR = CAST(#{bscDataDgr} AS NUMERIC)
			 	</when>
			 </choose>
			 <choose>
			 	<when test="prcsDgr != null and !prcsDgr.equals('')">
			 , PRCS_DGR = CAST(#{prcsDgr} AS NUMERIC)	
			 	</when>
			 	<otherwise>
			 , PRCS_DGR = 1
			 	</otherwise>
			 </choose>
			 <choose>
			 	<when test="vldMhdlgDgr != null and !vldMhdlgDgr.equals('')">
			 , VLD_MHDLG_DGR = CAST(#{vldMhdlgDgr} AS NUMERIC)
			 	</when>
			 	<otherwise>
			 , VLD_MHDLG_DGR = 0
			 	</otherwise>
			 </choose>
		<choose>
			<when test="addDataDmndPsbltyYn != null and !addDataDmndPsbltyYn.equals('')">
			 , ADD_DATA_DMND_PSBLTY_YN = #{addDataDmndPsbltyYn}
			</when>
			<otherwise>
			 , ADD_DATA_DMND_PSBLTY_YN = 'N'
			</otherwise>
		</choose>
		<choose>
			<when test="delYn != null and delYn.equals('Y')">
			 , DEL_YN = 'Y'
			</when>
			<otherwise>
			 , DEL_YN = 'N'
			</otherwise>
		</choose>
		 WHERE MHDLG_MGNO = #{mhdlgMgno}
	</update>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론상세 테이블 수정 -->
	<update id="updateMhdlgDtl" parameterType="map">
		/* AdmMhdlgAplyMapper.updateMhdlgDtl */
		UPDATE irsuser.MHDLG_DTL
		   SET DGR_REG_RSN_CD = #{dgrRegRsnCd}
			 , VLD_YN = #{vldYn}
			 <choose>
				<when test='vldYn != null and "Y".equals(vldYn)'>
			 , VLD_YMD = TO_CHAR(CURRENT_TIMESTAMP,'yyyyMMdd')
				</when>
				<otherwise>
			 , VLD_YMD = ''	
				</otherwise>
			 </choose>
			 <!-- , INST_MGNO = #{instMgno} -->  <!-- 최초 신청자 기관 --> 
			 <!-- , USER_ID = #{userId} -->		 <!-- 최초 신청자 USER_ID -->
			 , APLY_CL_CD = #{aplyClCd}
			 , AGREE_CLAUS_CD = #{agreeClausCd}
			 , MHDLG_ORGT_NM = #{mhdlgOrgtNm}
			 , MHDLG_KRN_NM = #{mhdlgKrnNm}
			 , VLD_BGNG_YMD = #{vldBgngYmd}
			 , PRPSD_FLMNO = #{prpsdFlmno}
			 , BIZ_PLND_FLMNO = #{bizPlndFlmno}
			 , ETC_DATA_FLMNO = #{etcDataFlmno}
			 , EXPLN_FLMNO = #{explnFlmno}
			 , CMPTNC_INST_NO = #{cmptncInstNo}
			 , APLY_TYPE_CD = #{aplyTypeCd}
		<choose>
			<when test='prcsTypeCd != null and prcsTypeCd.equals("MPT0001")'>			 
			 , APLY_YMD = ''
			</when>
			<otherwise>
			 , APLY_YMD = TO_CHAR(CURRENT_TIMESTAMP, 'yyyyMMdd')
			</otherwise>
		</choose>
			 , PRCS_TYPE_CD = #{prcsTypeCd}
			 , PRCS_YMD = TO_CHAR(CURRENT_TIMESTAMP, 'yyyyMMdd')
			 , ADD_DATA_TYPE_CD = #{addDataTypeCd}
			 , ADD_DATA_PRCS_YMD = #{addDataPrcsYmd}
			 , RVW_SN = CAST(#{rvwSn} AS NUMERIC)
			 , DIC_DLBR_SN = CAST(#{dicDlbrSn} AS NUMERIC)
			 , DLBR_SN = CAST(#{dlbrSn} AS NUMERIC)
		<choose>
			<when test="dtlTypeCd != null and !dtlTypeCd.equals('')">
			 , TYPE_CD = #{dtlTypeCd}
			</when>
		</choose>
		<choose>
			<when test="dtlDataDgr != null and !dtlDataDgr.equals('')">
			 , DATA_DGR = CAST( #{dtlDataDgr} AS NUMERIC)
			</when>
		</choose>
		<choose>
			<when test="delYn != null and !delYn.equals('')">
			 , DEL_YN = 'Y'
			</when>
			<otherwise>
			 , DEL_YN = 'N'
			</otherwise>
		</choose>
			 , MDFR_ID = #{sUserId}
			 , MDFCN_DT = CURRENT_TIMESTAMP
		 WHERE MHDLG_MGNO = #{mhdlgMgno}
		   AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
   	</update>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론 사업분야 테이블 삭제 -->
	<delete id="deleteMhdlgAgreeDtl" parameterType="map">
		/* AdmMhdlgAplyMapper.deleteMhdlgAgreeDtl */
		DELETE 
		  FROM irsuser.AGREE_STIPL_MHDLG_REL
		 WHERE CNCLD_MGNO = #{cncldMgno}
		   AND CNCLD_DGR = CAST(#{cncldDgr} AS NUMERIC)
		   AND MHDLG_MGNO = #{mhdlgMgno}
		   AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
	</delete>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 협정 방법론 테이블 삭제 -->
	<delete id="deleteMhdlgFldDtl" parameterType="map">
		/* AdmMhdlgAplyMapper.deleteMhdlgFldDtl */
		DELETE 
		  FROM irsuser.MHDLG_FLD_DTL
		 WHERE MHDLG_MGNO = #{mhdlgMgno}
		   AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
	</delete>
	
 	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론기본 테이블 수정 -->
	<update id="updateMhdlgFldList" parameterType="map">
		/* AdmMhdlgAplyMapper.updateMhdlgFldList */
		UPDATE irsuser.MHDLG_FLD_DTL
		   SET MDFR_ID = #{sUserId}
		   	 , MDFCN_DT = CURRENT_TIMESTAMP
		   	 , MHDLG_UNQNO = #{mhdlgUnqno}
		 WHERE MHDLG_MGNO = #{mhdlgMgno}
		   AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
		   AND BIZ_FLD_CD_MGNO = #{bizFldCdMgno}
		   AND BIZ_FLD_DTLS_CD_MGNO = #{bizFldDtlsCdMgno}
	</update>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 개정 차수 조회 -->
	<select id="selectMhdlgBscDgr" resultType="int" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgBscDgr */
		SELECT MAX(A.RVSN_DGR)+1
		  FROM irsuser.MHDLG_BSC A
		 INNER JOIN irsuser.mhdlg_dtl B
			ON A.MHDLG_MGNO = B.MHDLG_MGNO
		 WHERE A.MHDLG_GROUP_MGNO = #{mhdlgGroupMgno}
		   AND B.VLD_YN  = 'Y';
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 작상자 정보 -->
	<select id="selectRegInfo" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectRegInfo */
		SELECT 	
			 B.BZENT_NM
			,B.BRNO
			,A.FLNM
			,A.DEPT_NM
			,A.JBPS_NM
			,A.TEL_DDD || ' - ' || A.TEL_TLPNO || ' - ' || A.TEL_PHINO AS TEL
			,A.EML_ID || '@' || A.EML_ADDR AS EML
			,B.INST_MGNO
		FROM irsuser.USER_BSC A
		INNER JOIN irsuser.INST_BSC B
		ON A.INST_MGNO = B.INST_MGNO
		INNER JOIN irsuser.MHDLG_DTL C
		ON C.INST_MGNO = B.INST_MGNO
		WHERE 1=1
		AND A.USER_ID = C.USER_ID
		AND A.DEL_YN = 'N'
		AND B.DEL_YN = 'N'
		AND C.MHDLG_MGNO = #{mhdlgMgno}
		AND C.MHDLG_DGR = CAST( #{mhdlgDgr} AS NUMERIC)
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 직권신청 정보 -->
	<select id="selectAdminRegInfo" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectAdminRegInfo */
		SELECT 	
			 B.BZENT_NM
			,B.BRNO
			,A.FLNM
			,A.DEPT_NM
			,A.JBPS_NM
			,A.TEL_DDD || ' - ' || A.TEL_TLPNO || ' - ' || A.TEL_PHINO AS TEL
			,A.EML_ID || '@' || A.EML_ADDR AS EML
			,B.INST_MGNO
		FROM irsuser.USER_BSC A
		INNER JOIN irsuser.INST_BSC B
		ON A.INST_MGNO = B.INST_MGNO
		INNER JOIN irsuser.MHDLG_DTL C
		ON C.INST_MGNO = B.INST_MGNO
		WHERE 1=1
		AND A.USER_ID = C.USER_ID
		AND A.DEL_YN = 'N'
		AND B.DEL_YN = 'N'
		AND C.MHDLG_MGNO = #{mhdlgMgno}
		AND C.MHDLG_DGR = CAST( #{mhdlgDgr} AS NUMERIC)
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 > 개정이전 방법론 정보 조회 -->
	<select id="selectOldMhdlgNm" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectOldMhdlgNm */
		SELECT B.MHDLG_ORGT_NM||' ' AS OLD_MHDLG_ORGT_NM 
			 , B.MHDLG_KRN_NM||' ' AS OLD_MHDLG_KRN_NM 
		  FROM irsuser.MHDLG_BSC A
		 INNER JOIN irsuser.MHDLG_DTL B
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO
		 WHERE A.MHDLG_GROUP_MGNO = #{mhdlgGroupMgno}
		   AND A.RVSN_DGR = CAST(#{rvsnDgr} AS NUMERIC)-1
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 사업분야 목록 조회 -->
	<select id="selectMhdlgFldList" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgFldList */
		SELECT B.BIZ_FLD_CD_MGNO
			 , B.BIZ_FLD_KORN_NM
			 , C.BIZ_FLD_DTLS_CD_MGNO
			 , C.BIZ_DTLS_FLD_KORN_NM
			 , A.MHDLG_UNQNO
			 , '' AS CHK
		  FROM irsuser.MHDLG_FLD_DTL A
		 INNER JOIN irsuser.COM_BIZ_FLD_BSC B
		    ON B.BIZ_FLD_CD_MGNO = A.BIZ_FLD_CD_MGNO
		 INNER JOIN irsuser.COM_BIZ_FLD_DTL C 
		    ON C.BIZ_FLD_DTLS_CD_MGNO = A.BIZ_FLD_DTLS_CD_MGNO
		   AND B.BIZ_FLD_CD_MGNO = C.BIZ_FLD_CD_MGNO
		 WHERE A.MHDLG_MGNO = #{mhdlgMgno}
	   	   AND A.MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 협정약정 목록 조회 -->
	<select id="selectAgrStiplList" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectAgrStiplList */
		SELECT '' AS CHK
			 , U.CNCLD_MGNO
			 , CAST(U.CNCLD_DGR AS TEXT) AS CNCLD_DGR
			 , U.CNCLD_ORGT_NM
			 , U.CNCLD_KRN_NM
			 , irsuser.FN_GET_CODENM('CNCLD_CL_CD', U.CNCLD_CL_CD) AS CNCLD_CL_CD_NM
			 , CASE WHEN CAST(U.CNCLD_DGR AS INTEGER) = 1 THEN '신규' ELSE '개정' END AS CNCLD_DGR_NM
			 , U.SGNT_YMD
			 , U.EFTVN_YMD
			 , (
				SELECT ARRAY_TO_STRING(ARRAY_AGG(T.NTN_NM), ', ') AS NM
				  FROM (
					    SELECT (
					    		SELECT NTN_KORN_NM 
					    		  FROM irsuser.COM_NTN_CD_BSC 
					    		 WHERE IATA_NTN_CD = A.NTN_CD
					    	    ) AS NTN_NM
						  FROM irsuser.AGREE_STIPL_NTN_DTL A
						 WHERE 1=1
						   AND A.CNCLD_MGNO = U.CNCLD_MGNO
						   AND A.CNCLD_DGR = U.CNCLD_DGR
						   AND A.DEL_YN = 'N'
						) T
			  	) AS NTN_NM
			 , U.MHDLG_MGNO
			 , U.MHDLG_DGR
		  FROM (
				SELECT A.CNCLD_MGNO
					 , A.CNCLD_DGR
					 , A.CNCLD_ORGT_NM
					 , A.CNCLD_KRN_NM
					 , A.CNCLD_CL_CD
					 , A.SGNT_YMD
					 , A.EFTVN_YMD
					 , B.MHDLG_MGNO 
					 , B.MHDLG_DGR 
				  FROM irsuser.AGREE_STIPL_BSC A
				 INNER JOIN irsuser.AGREE_STIPL_MHDLG_REL B
				    ON B.CNCLD_MGNO = A.CNCLD_MGNO
				   AND B.CNCLD_DGR = A.CNCLD_DGR 
				 WHERE 1=1
				   AND A.DEL_YN = 'N'
				   AND B.MHDLG_MGNO = #{mhdlgMgno}
				   AND B.MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
				   AND B.CNCLD_DGR = (SELECT MAX(CNCLD_DGR)
				   						FROM irsuser.AGREE_STIPL_MHDLG_REL
				   					   WHERE MHDLG_MGNO = #{mhdlgMgno}
				   						 AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
				   					)
				 
				) U
		
		
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 문서재출이력 -->
	<select id="selectMhdlgAplyDocList" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyDocList */
		SELECT
			 (COUNT(*) OVER()) - (U.RN-1) AS NO
			,U.*
		FROM (
			SELECT
				 ROW_NUMBER() OVER() AS RN
				,V.*
			FROM (
				SELECT DISTINCT B.MHDLG_MGNO
						 , B.MHDLG_DGR
						 , B.APLY_YMD
						 , IRSUSER.FN_GET_CODENM('APLY_TYPE_CD', B.APLY_TYPE_CD) AS APLY_TYPE_CD_NM
						 , CASE WHEN COALESCE(B.PRCS_YMD, '') = '' THEN '-' ELSE B.PRCS_YMD END AS PRCS_YMD 
						 , B.PRCS_TYPE_CD
						 , CASE WHEN B.PRCS_TYPE_CD = 'MPT0003' OR B.PRCS_TYPE_CD = 'MPT0004' OR B.PRCS_TYPE_CD = 'MPT0005' 
									 OR B.PRCS_TYPE_CD = 'MPT0006' OR B.PRCS_TYPE_CD = 'MPT0007' OR B.PRCS_TYPE_CD = 'MPT0008' THEN 
								   ( SELECT T3.BZENT_NM  
									   FROM IRSUSER.MHDLG_DTL T1
									  INNER JOIN IRSUSER.MHDLG_RVW_DTL T2
										 ON T1.RVW_SN = T2.RVW_SN 
									  INNER JOIN IRSUSER.INST_BSC T3
										 ON T2.RVW_INST_CD = T3.INST_MGNO 
									  WHERE 1=1
										AND T1.MHDLG_MGNO = B.MHDLG_MGNO
										AND T1.MHDLG_DGR = B.MHDLG_DGR
									)
								WHEN B.PRCS_TYPE_CD = 'MPT0009' OR B.PRCS_TYPE_CD = 'MPT0010' OR B.PRCS_TYPE_CD = 'MPT0011' 
									 OR B.PRCS_TYPE_CD = 'MPT0012' OR B.PRCS_TYPE_CD = 'MPT0013' OR B.PRCS_TYPE_CD = 'MPT0014' THEN 
								   ( SELECT T3.BZENT_NM  
									   FROM IRSUSER.MHDLG_DTL T1
									  INNER JOIN IRSUSER.MHDLG_DIC_DLBR_DTL  T2
										 ON T1.DIC_DLBR_SN = T2.DIC_DLBR_SN 
										AND T2.DIC_DLBR_DGR = (SELECT MAX(DIC_DLBR_DGR) FROM IRSUSER.MHDLG_DIC_DLBR_DTL WHERE DIC_DLBR_SN = T2.DIC_DLBR_SN)
									  INNER JOIN IRSUSER.INST_BSC T3
										 ON T2.DIC_DLBR_INST_CD = T3.INST_MGNO 
									  WHERE 1=1
										AND T1.MHDLG_MGNO = B.MHDLG_MGNO
										AND T1.MHDLG_DGR = B.MHDLG_DGR
									)
								WHEN B.PRCS_TYPE_CD = 'MPT0015' OR B.PRCS_TYPE_CD = 'MPT0016' OR B.PRCS_TYPE_CD = 'MPT0017' OR B.PRCS_TYPE_CD = 'MPT0018' 
									OR B.PRCS_TYPE_CD = 'MPT0019' OR B.PRCS_TYPE_CD = 'MPT0020' OR B.PRCS_TYPE_CD = 'MPT0021' THEN 
								   ( SELECT T3.BZENT_NM
									   FROM IRSUSER.MHDLG_DTL T1
									  INNER JOIN IRSUSER.MHDLG_DLBR_DTL T2
										 ON T1.DLBR_SN = T2.DLBR_SN 
										AND T2.DLBR_DGR = (SELECT MAX(DLBR_DGR) FROM IRSUSER.MHDLG_DLBR_DTL WHERE DLBR_SN = T2.DLBR_SN)
									  INNER JOIN IRSUSER.INST_BSC T3
										 ON T2.DLBR_RSLT_INPT_INST_CD = T3.INST_MGNO 
									  WHERE 1=1
										AND T1.MHDLG_MGNO = B.MHDLG_MGNO
										AND T1.MHDLG_DGR = B.MHDLG_DGR
									)
								ELSE '-' 
						   END AS PRCS_USER_NM
						 , IRSUSER.FN_GET_CODENM('MHDLG_PRCS_TYPE_CD', B.PRCS_TYPE_CD) AS PRCS_TYPE_CD_NM
						 , CASE WHEN CAST(#{mhdlgDgr} AS NUMERIC) = B.MHDLG_DGR THEN '현재문서' 
								ELSE '상세보기' END AS BTN_CTL
					  FROM IRSUSER.MHDLG_BSC A
					 INNER JOIN IRSUSER.MHDLG_DTL B
						ON A.MHDLG_MGNO = B.MHDLG_MGNO 
					 WHERE 1=1
					   AND A.MHDLG_MGNO = #{mhdlgMgno}
					   AND A.DEL_YN = 'N'
					   AND B.DEL_YN = 'N'
					 ORDER BY B.MHDLG_DGR DESC
			) V
		) U
	</select>
	

	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론상세 차수 조회 -->
	<select id="selectMhdlgDgr" resultType="int" parameterType="map">
		/* BizMhdlgAplyMapper.selectMhdlgBscDgr */
		SELECT MAX(MHDLG_DGR)+1
		  FROM irsuser.mhdlg_dtl
		 WHERE MHDLG_MGNO = #{mhdlgMgno}
		   AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 접근권한 조회 -->
	<select id="selectAsessAuth" resultType="egovMap" parameterType="map">
	/* AdmMhdlgAplyMapper.selectAsessAuth */
	   SELECT CASE WHEN A.user_id = B.user_id THEN 'Y'
	   			   ELSE 'N'
	   		  END AS WRITE_YN
	   		, CASE WHEN A.cmptnc_inst_no = B.inst_mgno        /* 관장기관 */ 
	   					OR cmptnc_inst_no = B.up_inst_mgno    /* 상위기관 */
	   					OR B.user_cl_cd = 'UCC0001' THEN 'Y'  /* 전체관리자 */
	   			   ELSE 'N'
	   		  END AS DLBR_WRITE_YN
	     FROM irsuser.MHDLG_DTL A
	     LEFT OUTER JOIN irsuser.user_bsc B 
	       ON 1=1
		WHERE A.MHDLG_MGNO  = #{mhdlgMgno}
		  AND A.MHDLG_DGR  = CAST(#{mhdlgDgr} AS NUMERIC)
		  AND B.USER_ID = #{sUserId}
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 신청자정보 -->
	<select id="selectSessionUserInfo" resultType="egovMap" parameterType="map">
		/* BizMhdlgAplyMapper.selectSessionUserInfo */
		SELECT 	
			 B.BZENT_NM
			,B.BRNO
			,A.FLNM
			,A.DEPT_NM
			,A.JBPS_NM
			,A.TEL_DDD || ' - ' || A.TEL_TLPNO || ' - ' || A.TEL_PHINO AS TEL
			,A.EML_ID || '@' || A.EML_ADDR AS EML
			,B.INST_MGNO
		FROM irsuser.USER_BSC A
		INNER JOIN irsuser.INST_BSC B
		ON A.INST_MGNO = B.INST_MGNO
		WHERE 1=1
		AND A.USER_ID = #{sUserId}
		AND A.DEL_YN = 'N'
		AND B.DEL_YN = 'N'
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 액셀다운로드 -->
	<select id="selectMhdlgAplyExcel" resultType="egovMap" parameterType="map">
		/* AdmMhdlgAplyMapper.selectMhdlgAplyListExcel */
		SELECT UU.RNN AS NO				  													/* 순번 */
	 		 , irsuser.FN_GET_CODENM('MHDLG_APLY_CL_CD', UU.APLY_CL_CD)	AS APLY_TYPE_NM		/* 신청구분명 */
	 		 , irsuser.FN_GET_CODENM('AGREE_CLAUS_CD', UU.AGREE_CLAUS_CD) AS AGREE_CLAUS_NM	/* 협정조항명 */
	 		 , UU.BZENT_NM				 							 						/* 기관명 - 신청기관 */ 
	 		 , UU.GOV_BZENT_NM		      													/* 관할기관명  - 관장기관 */
	 		 , UU.APLY_YMD                													/* 신청일자 */
	 		 , UU.MHDLG_KRN_NM            													/* 방법론 한글명 */
	 		 , UU.MHDLG_ORGT_NM            													/* 방법론 원문명 */
	 		 , UU.MHDLG_UNQNO            													/* 방법론 고유번호 */
			 , UU.VLD_BGNG_YMD            													/* 유효시작일 */	 		 
			 , irsuser.FN_GET_CODENM('MHDLG_PRCS_TYPE_CD',UU.PRCS_TYPE_CD) AS	PRCS_TYPE_NM		/* 처리유형코드명 */
			 , irsuser.FN_GET_CODENM('MHDLG_PRCND_TYPE_CD',UU.REG_RSN_CD) AS REG_RSN_NM		/* 제정/개정 명 */
			 , CASE WHEN ARRAY_LENGTH(UU.MHDLG_FLD_ARRAY, 1) > 1 THEN ARRAY_TO_STRING(UU.MHDLG_FLD_ARRAY,  E'\n')
			        ELSE UU.MHDLG_FLD_ARRAY[1]
			   END AS MHDLG_FLD_LIST_TEXT
		  FROM (
            	 SELECT VV.RNN
            		  , VV.MHDLG_MGNO
            		  , VV.MHDLG_DGR        
            		  , VV.INST_MGNO        
            		  , VV.CMPTNC_INST_NO   
            		  , VV.APLY_YMD         
            		  , VV.MHDLG_KRN_NM     
            		  , VV.MHDLG_ORGT_NM     
            		  , VV.APLY_CL_CD   
            		  , VV.AGREE_CLAUS_CD     
            		  , VV.VLD_BGNG_YMD     
            		  , VV.REG_RSN_CD     
            		  , VV.MHDLG_UNQNO     
            		  , VV.PRCS_TYPE_CD     
            		  , VV.ADD_DATA_TYPE_CD     
            		  , VV.REG_DT
            		  , VV.ADD_DATA_DMND_PSBLTY_YN
            		  , VV.BZENT_NM
            		  , GIB.BZENT_NM AS GOV_BZENT_NM
            		  , VV.TYPE_CD
            		  , VV.DATA_DGR
            		  , VV.APLY_TYPE_CD
            		  , (
                         SELECT ARRAY_AGG(X.MHDLG_FLD)
                           FROM (
                                 SELECT
                                        CASE WHEN Z.MHDLG_FLD_TOTAL_CNT = 1 THEN Z.MHDLG_FLD                        	/* 1건이면 문자만 출력 */
                                             ELSE '(' || MHDLG_FLD_ROWNUM || ') ' || Z.MHDLG_FLD                	    /* 2건이상이면 앞에 (1) 숫자 붙이기 */
                                        END AS MHDLG_FLD
                                   FROM
                                        (
                                         SELECT GRP_CD.BIZ_FLD_KORN_NM || ' - ' || DTL_CD.BIZ_DTLS_FLD_KORN_NM AS MHDLG_FLD
                                              , ROW_NUMBER() OVER(PARTITION BY MFD.MHDLG_MGNO, MFD.MHDLG_DGR ORDER BY DTL_CD.BIZ_FLD_DTLS_CD_MGNO) AS MHDLG_FLD_ROWNUM
                                              , COUNT(*) OVER() MHDLG_FLD_TOTAL_CNT
                                           FROM irsuser.MHDLG_FLD_DTL MFD                            					 /* 방법론 사업세부분야 */
                                          INNER JOIN irsuser.COM_BIZ_FLD_BSC GRP_CD
                                             ON GRP_CD.BIZ_FLD_CD_MGNO = MFD.BIZ_FLD_CD_MGNO
                                          INNER JOIN irsuser.COM_BIZ_FLD_DTL DTL_CD
                                             ON DTL_CD.BIZ_FLD_DTLS_CD_MGNO = MFD.BIZ_FLD_DTLS_CD_MGNO
                                          WHERE MFD.MHDLG_MGNO = VV.MHDLG_MGNO
                                            AND MFD.MHDLG_DGR = VV.MHDLG_DGR
                                        ) Z
                                ) X
                        ) AS MHDLG_FLD_ARRAY                                                                  	 		 /* 방법론 분야정보 - 배열로 조립하기 */
                      , (SELECT CASE WHEN VV.cmptnc_inst_no = A.inst_mgno        /* 관장기관 */ 
   										OR VV.cmptnc_inst_no = A.up_inst_mgno    /* 상위기관 */
	   									OR A.user_cl_cd = 'UCC0001' THEN 'Y'  /* 전체관리자 */
									 ELSE 'N'
								END AS DLBR_WRITE_YN
						   FROM irsuser.user_bsc A
						  WHERE A.USER_ID = #{sUserId}) AS DLBR_WRITE_YN
              	   FROM (
                   		 SELECT U.TOTAL_CNT - U.RN + 1 AS RNN
                    	 	  , U.MHDLG_MGNO
                    	 	  , U.MHDLG_DGR        
                    	 	  , U.INST_MGNO        
                    	 	  , U.CMPTNC_INST_NO   
                    	 	  , U.APLY_YMD         
                    	 	  , U.MHDLG_KRN_NM     
                    	 	  , U.MHDLG_ORGT_NM     
                    	 	  , U.APLY_CL_CD     
                    	 	  , U.AGREE_CLAUS_CD     
                    	 	  , U.VLD_BGNG_YMD     
                    	 	  , U.REG_RSN_CD     
                    	 	  , U.MHDLG_UNQNO     
                    	 	  , U.PRCS_TYPE_CD     
                    	 	  , U.ADD_DATA_TYPE_CD     
                    	 	  , U.REG_DT
                    	 	  , U.ADD_DATA_DMND_PSBLTY_YN
                    	 	  , U.BZENT_NM 
                    	 	  , U.TYPE_CD
                    	 	  , U.DATA_DGR
                    	 	  , U.APLY_TYPE_CD
                          FROM (
				                                SELECT ROW_NUMBER() OVER( ORDER BY MB.MHDLG_MGNO DESC) AS RN
				                            		 , COUNT(*) OVER() AS TOTAL_CNT 
                                                     , MB.MHDLG_MGNO
                                                     , MD.MHDLG_DGR
                                                     , MD.INST_MGNO                 /* 기관관리번호 - 업체명 */
                                                     , MD.CMPTNC_INST_NO        	/* 관할기관번호 - 관장기관 */
                                                     , MD.APLY_YMD                	/* 신청일자 */
                                                     , MD.MHDLG_KRN_NM            	/* 방법론 한글명 */
                                                     , MD.MHDLG_ORGT_NM            	/* 방법론 원문명 */
                                                     , MD.APLY_CL_CD            	/* 신청구분코드 */
                                                     , MD.AGREE_CLAUS_CD 			/* 협정조항코드 */
                                                     , MD.VLD_BGNG_YMD            	/* 유효시작일 */
                                                     , MB.REG_RSN_CD				/* 제정/개정 */
                                                     , MB.MHDLG_UNQNO				/* 방법론 고유번호 */
                                                     , MD.PRCS_TYPE_CD				/* 처리유형코드 */
                                                     , MD.ADD_DATA_TYPE_CD			/* 추가자료유형코드 */
                                                     , MD.REG_DT                	/* 등록일자 */
                                                     , MB.ADD_DATA_DMND_PSBLTY_YN
                                                     , IB.BZENT_NM 
                                                     , MB.TYPE_CD
                                                     , MB.DATA_DGR
                                                     , MD.APLY_TYPE_CD
                                                  FROM irsuser.MHDLG_BSC MB
                                                 INNER JOIN irsuser.MHDLG_DTL MD
                                                 	ON MD.MHDLG_MGNO = MB.MHDLG_MGNO
                                                   AND MD.MHDLG_DGR = MB.PRCS_DGR 
                                                 INNER JOIN irsuser.INST_BSC IB                    /* 업체 */
                                                 	ON IB.INST_MGNO = MD.INST_MGNO
                                                 WHERE MB.DEL_YN = 'N'
                                                   AND MD.DEL_YN = 'N'
                                                   AND MD.PRCS_TYPE_CD != 'MPT0001'
												<if test="srhAplyClCd != null and !srhAplyClCd.equals('')">
                                                   AND MD.APLY_CL_CD = #{srhAplyClCd}
												</if>
												<if test="srhAddDataYn != null and !srhAddDataYn.equals('')">
                                                   AND COALESCE(MD.ADD_DATA_TYPE_CD, '') != ''
												</if>
												<if test="srhMhdlgPrcndTypeCd != null and !srhMhdlgPrcndTypeCd.equals('')">
                                                   AND MB.REG_RSN_CD = #{srhMhdlgPrcndTypeCd}
												</if>
												<if test="srhPrcsTypeCd != null and !srhPrcsTypeCd.equals('')">
                                                   AND MD.PRCS_TYPE_CD = #{srhPrcsTypeCd}
												</if>
												<if test="srhInstMngNo != null and !srhInstMngNo.equals('')">
												   AND MD.CMPTNC_INST_NO = #{srhInstMngNo}
												</if>
												<if test="srhMhdlgNm != null and !srhMhdlgNm.equals('')">
                                                   AND MD.MHDLG_ORGT_NM LIKE CONCAT('%', #{srhMhdlgNm}, '%')		
                                                    OR MD.MHDLG_KRN_NM LIKE CONCAT('%', #{srhMhdlgNm}, '%')		
												</if>												
												<if test="srhBizFldCd != null and !srhBizFldCd.equals('')">
                                                   AND EXISTS ( SELECT 1
                                                                  FROM irsuser.MHDLG_FLD_DTL SMFD
                                                                 WHERE SMFD.MHDLG_MGNO = MD.MHDLG_MGNO
                                                                   AND SMFD.MHDLG_DGR = MD.MHDLG_DGR
                                                                   AND SMFD.BIZ_FLD_CD_MGNO = LTRIM(#{srhBizFldCd},'0')
                                                <if test="srhBizDtlsFldCd != null and !srhBizDtlsFldCd.equals('')">
                                                                   AND SMFD.BIZ_FLD_DTLS_CD_MGNO = #{srhBizDtlsFldCd} 
												</if>
                                                 			   )
                                                 
												</if>
                              			 ) U
					LIMIT CAST( #{srhTo} AS NUMERIC)
					OFFSET CAST ( #{srhFrom} AS NUMERIC) -1
        
                    ) VV
             	   LEFT OUTER JOIN irsuser.INST_BSC GIB            /* 관장기관 */
                	 ON GIB.INST_MGNO = VV.CMPTNC_INST_NO
                  ORDER BY VV.RNN DESC
		  	 ) UU
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 방법론 제·개정 이력 조회 -->
	<select id="selectRvsnHistory" resultType="egovMap" parameterType="map">
		SELECT CAST(A.RVSN_DGR AS TEXT) || '차' AS RVSN_DGR_NM
			 , TO_CHAR(TO_DATE(B.VLD_YMD,'YYYYMMDD'),'YYYY-MM-DD') AS VLD_YMD
			 , B.MHDLG_ORGT_NM 
			 , B.MHDLG_KRN_NM 
		  FROM irsuser.MHDLG_BSC A
		 INNER JOIN irsuser.MHDLG_DTL B 
			ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		 WHERE A.MHDLG_GROUP_MGNO = #{mhdlgGroupMgno}
		   AND B.MHDLG_DGR  = A.PRCS_DGR
		   AND B.VLD_YN = 'Y'
		 ORDER BY rvsn_dgr DESC;
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 관장기관 조회 -->
	<select id="selectCmptncInstInfo" resultType="egovMap" parameterType="map">
		SELECT CASE WHEN C.CMPTNC_INST_NO != '' THEN C.CMPTNC_INST_NO
					WHEN D.MHDLG_INST_MGNO != '' THEN D.MHDLG_INST_MGNO
					ELSE 'GV00000002'
			   END AS CMPTNC_INST_NO 
		  FROM irsuser.MHDLG_DTL A
		 INNER JOIN irsuser.MHDLG_FLD_DTL B
		    ON B.MHDLG_MGNO = A.MHDLG_MGNO 
		   AND B.MHDLG_DGR  = A.MHDLG_DGR 
		 INNER JOIN irsuser.COM_BIZ_FLD_DTL C
		    ON C.BIZ_FLD_DTLS_CD_MGNO = B.BIZ_FLD_DTLS_CD_MGNO 
		   AND C.BIZ_FLD_CD_MGNO  = B.BIZ_FLD_CD_MGNO
		  LEFT OUTER JOIN irsuser.INST_STNG_DTL D
		    ON D.inst_mgno = A.inst_mgno 
		 WHERE A.MHDLG_MGNO = #{mhdlgMgno}
		   AND A.MHDLG_DGR = CAST ( #{mhdlgDgr} AS NUMERIC)
	</select>
	
	<insert id="insertMhdlgAplyHstry" parameterType="map">
		INSERT 
		  INTO irsuser.MHDLG_HSTRY 
		     ( MHDLG_MGNO
			 , MHDLG_DGR
			 , HSTRY_TYPE_CD
			 , HSTRY_RSLT_CD
			 , HSTRY_YMD
			 , HSTRY_DTL_RSN
			 , DEL_YN
			 , RGTR_ID
			 , REG_DT			
			 ) 
		VALUES 
			 ( #{mhdlgMgno}
			 , CAST(#{mhdlgDgr} AS NUMERIC)
			 , #{hstryTypeCd}
			 , #{hstryRsltCd}
			 , TO_CHAR(CURRENT_TIMESTAMP, 'YYYYMMDD')
			 , #{hstryDtlRsn}
			 , 'N'
			 , #{sUserId}
			 , CURRENT_TIMESTAMP	
			 )
	</insert>
	
	<select id="selectMhdlgAplyAddDataList" resultType="egovMap" parameterType="map">
		SELECT 
			 A.MHDLG_MGNO
			,A.MHDLG_DGR
			,CAST(A.ADD_DATA_DGR AS TEXT) AS ADD_DATA_DGR
			,A.DATA_DMND_TYPE_CD
			,IRSUSER.FN_GET_CODENM('DATA_DMND_TYPE_CD', A.DATA_DMND_TYPE_CD) AS DATA_DMND_TYPE_CD_NM
			,TO_CHAR(A.DATA_DMND_DT, 'YYYY-MM-DD HH24:MI:SS') AS DATA_DMND_DT
			,A.DATA_DMND_RSN
			,A.DATA_DMND_FLMNO
			,A.DATA_DMND_INST_CD
			,COALESCE(A.DATA_DMND_YN, 'N') AS DATA_DMND_YN
			,A.DATA_RQSTR_ID
			,A.DATA_REG_TYPE_CD
			,IRSUSER.FN_GET_CODENM('DATA_REG_TYPE_CD', A.DATA_REG_TYPE_CD) AS DATA_REG_TYPE_CD_NM
			,A.DATA_REG_CN
			,TO_CHAR(A.DATA_REG_DT, 'YYYY-MM-DD HH24:MI:SS') AS DATA_REG_DT
			,A.DATA_RGTR_ID
			,A.BIZ_PLND_FLMNO
			,A.ETC_DATA_FLMNO
			,A.PRPSD_FLMNO
			,A.DATA_IDNTY_TYPE_CD
			,IRSUSER.FN_GET_CODENM('DATA_IDNTY_TYPE_CD', A.DATA_IDNTY_TYPE_CD) AS DATA_IDNTY_TYPE_CD_NM
			,A.DATA_IDNTY_CN
			,TO_CHAR(A.DATA_IDNTY_DT, 'YYYY-MM-DD HH24:MI:SS') AS DATA_IDNTY_DT
			,A.DATA_IDNTY_INST_CD
			,A.DATA_IDFR_ID
			,A.DEL_YN
			,A.RGTR_ID
			,A.REG_DT
			,A.MDFR_ID
			,A.MDFCN_DT
			,CASE WHEN A.DATA_IDNTY_TYPE_CD = 'DIT0001' THEN '추가자료확인(승인)'
				  WHEN A.DATA_IDNTY_TYPE_CD = 'DIT0002' THEN '추가자료확인(반려)'
				  WHEN A.DATA_REG_TYPE_CD = 'DRT0001' THEN '추가자료제출'
				  WHEN A.DATA_DMND_TYPE_CD = 'DAT0001' THEN '추가자료요청'
			 ELSE '-'
			 END AS STS
			,CASE WHEN CAST(#{addDataDgr} AS NUMERIC) = A.ADD_DATA_DGR THEN '현재문서' ELSE '상세보기' END AS BTN_CTL
		FROM IRSUSER.MHDLG_ADD_DATA_DTL A
		WHERE 1=1
		AND A.MHDLG_MGNO= #{mhdlgMgno}
		AND A.DEL_YN = 'N'
		ORDER BY A.ADD_DATA_DGR DESC
	</select>
	
	<update id="updateMhdlgAplyAddCfm" parameterType="map">
		UPDATE irsuser.MHDLG_ADD_DATA_DTL SET
			 DATA_IDNTY_TYPE_CD = #{dataIdntyTypeCd}
			,DATA_IDNTY_CN = #{dataIdntyCn}
			,DATA_IDNTY_DT = CURRENT_TIMESTAMP
			,DATA_IDNTY_INST_CD = (SELECT INST_MGNO FROM irsuser.USER_BSC WHERE USER_ID = #{sUserId}) 
			,DATA_IDFR_ID = #{sUserId} 
			,MDFR_ID = #{sUserId} 
			,MDFCN_DT = CURRENT_TIMESTAMP	
		WHERE 1=1
		AND MHDLG_MGNO = #{mhdlgMgno}
		AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
		AND ADD_DATA_DGR = CAST(#{addDataDgr} AS NUMERIC)
	</update>
	
	<select id="selectMhdlgAplyAddData" resultType="egovMap" parameterType="map">
			SELECT 
			 A.MHDLG_MGNO
			,A.MHDLG_DGR
			,CAST(A.ADD_DATA_DGR AS TEXT) AS ADD_DATA_DGR
			,A.DATA_DMND_TYPE_CD
			,A.DATA_DMND_DT
			,A.DATA_DMND_RSN
			,A.DATA_DMND_FLMNO
			,A.DATA_DMND_INST_CD
			,COALESCE(A.DATA_DMND_YN, 'N') AS DATA_DMND_YN
			,A.DATA_RQSTR_ID
			,A.DATA_REG_TYPE_CD
			,A.DATA_REG_CN
			,A.DATA_REG_DT
			,A.DATA_RGTR_ID
			,A.PRPSD_FLMNO
			,A.BIZ_PLND_FLMNO
			,A.ETC_DATA_FLMNO
			,COALESCE(A.DATA_IDNTY_TYPE_CD, '') AS DATA_IDNTY_TYPE_CD
			,A.DATA_IDNTY_CN
			,A.DATA_IDNTY_DT
			,A.DATA_IDNTY_INST_CD
			,A.DATA_IDFR_ID
			,A.DEL_YN
			,A.RGTR_ID
			,A.REG_DT
			,A.MDFR_ID
			,A.MDFCN_DT
		FROM irsuser.MHDLG_ADD_DATA_DTL A
		WHERE 1=1
		AND A.MHDLG_MGNO = #{mhdlgMgno}
		AND A.ADD_DATA_DGR = CAST(#{addDataDgr} AS NUMERIC)
		AND A.DEL_YN = 'N'
	</select>
	
	<update id="updateMhdlgAplyAddDtlWithFile" parameterType="map">
		UPDATE irsuser.MHDLG_DTL SET 
			 ADD_DATA_TYPE_CD = #{addDataTypeCd} 
			,ADD_DATA_PRCS_YMD = TO_CHAR(CURRENT_TIMESTAMP, 'YYYYMMDD')
			,PRPSD_FLMNO = #{prpsdFlmno}
			,BIZ_PLND_FLMNO = #{bizPlndFlmno}
			,ETC_DATA_FLMNO = #{etcDataFlmno}
			,MDFR_ID = #{sUserId} 
			,MDFCN_DT = CURRENT_TIMESTAMP 	
		WHERE 1=1
		AND MHDLG_MGNO = #{mhdlgMgno}
		AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
	</update>
	
	<update id="updateMhdlgAplyAddDtlWithYmd" parameterType="map">
		UPDATE irsuser.MHDLG_DTL SET
			 ADD_DATA_TYPE_CD = #{addDataTypeCd} 
			,ADD_DATA_PRCS_YMD = TO_CHAR(CURRENT_TIMESTAMP, 'YYYYMMDD')
			,PRPSD_FLMNO = #{prpsdFlmno}
			,BIZ_PLND_FLMNO = #{bizPlndFlmno}
			,ETC_DATA_FLMNO = #{etcDataFlmno}
			,MDFR_ID = #{sUserId} 
			,MDFCN_DT = CURRENT_TIMESTAMP 	
		WHERE 1=1
		AND MHDLG_MGNO = #{mhdlgMgno}
		AND MHDLG_DGR = CAST(#{mhdlgDgr} AS NUMERIC)
	</update>
	
	<select id="selectMhdlgAplyAddDataEmpty" resultType="egovMap" parameterType="map">
		SELECT 
			 '' AS MHDLG_MGNO
			,'' AS MHDLG_DGR
			,'' AS ADD_DATA_DGR
			,'' AS DATA_DMND_TYPE_CD
			,'' AS DATA_DMND_DT
			,'' AS DATA_DMND_RSN
			,'' AS DATA_DMND_FLMNO
			,'' AS DATA_DMND_INST_CD
			,'N' AS DATA_DMND_YN
			,'' AS DATA_RQSTR_ID
			,'' AS DATA_REG_TYPE_CD
			,'' AS DATA_REG_CN
			,'' AS DATA_REG_DT
			,'' AS DATA_RGTR_ID
			,'' AS PRPSD_FLMNO
			,'' AS BIZ_PLND_FLMNO
			,'' AS ETC_DATA_FLMNO
			,'' AS DATA_IDNTY_TYPE_CD
			,'' AS DATA_IDNTY_CN
			,'' AS DATA_IDNTY_DT
			,'' AS DATA_IDNTY_INST_CD
			,'' AS DATA_IDFR_ID
			,'' AS DEL_YN
			,'' AS RGTR_ID
			,'' AS REG_DT
			,'' AS MDFR_ID
			,'' AS MDFCN_DT
	</select>
	
	<!-- [관리자] 방법론관리 > 방법론 신청 관리 - 사전심의 이의신청등록 -->
	<update id="updateMhdlgAplyDicDlbrObjcAply" parameterType="map">
		/* AdmMhdlgAplyMapper.updateMhdlgAplyDicDlbrObjcAply */
		UPDATE irsuser.MHDLG_DIC_DLBR_DTL
		   SET OBJC_APLY_OPNN = #{objcAplyOpnn}
			 , OBJC_APLY_FLMNO = #{objcAplyFlmno}
			 , OBJC_APLY_YMD = TO_CHAR(CURRENT_TIMESTAMP,'yyyyMMdd')
		 WHERE DIC_DLBR_SN = CAST(#{dicDlbrSn} AS NUMERIC)
		   AND DIC_DLBR_DGR = CAST(#{dicDlbrDgr} AS NUMERIC)
		   AND MHDLG_MGNO = #{mhdlgMgno}
	</update>
	
	<!-- [사용자] 방법론관리 > 방법론 신청 관리 - 심의 이의신청등록 -->
	<update id="updateMhdlgAplyDlbrObjcAply" parameterType="map">
		/* AdmMhdlgAplyMapper.updateMhdlgAplyDlbrObjcAply */
		UPDATE irsuser.MHDLG_DLBR_DTL
		   SET OBJC_APLY_OPNN = #{objcAplyOpnn}
			 , OBJC_APLY_FLMNO = #{objcAplyFlmno}
			 , OBJC_APLY_YMD = TO_CHAR(CURRENT_TIMESTAMP,'yyyyMMdd')
		 WHERE DLBR_SN = CAST(#{dlbrSn} AS NUMERIC)
		   AND DLBR_DGR = CAST(#{dlbrDgr} AS NUMERIC)
		   AND MHDLG_MGNO = #{mhdlgMgno}
	</update>
		
</mapper>
